(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7688],{2112:function(e,o,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/project/[ref]/database/tables",function(){return n(40072)}])},51343:function(e,o,n){"use strict";n.d(o,{Z:function(){return TableGridEditor_DeleteConfirmationDialogs}});var t=n(52322),l=n(55830),i=n(39097),a=n.n(i),r=n(62202),s=n(1681),c=n(44593),d=n(73205),u=n(94580),m=n(63157),f=n(99902),v=n(2755),g=n(98050),h=n(27924),b=n(74596),w=n(62350),y=n(90507),D=n(70481),p=n(74915),C=n(11033),j=n(77565);async function deleteAllTableRow(e){let{projectRef:o,connectionString:n,table:t,filters:l,impersonatedRole:i}=e,a=(0,p.Jh)(function(e){var o;let{table:n,filters:t}=e,l=new y.AE().from(n.name,null!==(o=n.schema)&&void 0!==o?o:void 0).delete();return t.filter(e=>e.value&&""!==e.value).forEach(e=>{let o=(0,j.q)(n,e);l=l.filter(e.column,e.operator,o)}),l.toSql()}({table:t,filters:l}),{projectRef:o,role:i}),{result:r}=await (0,D.Rj)({projectRef:o,connectionString:n,sql:a,isRoleImpersonationEnabled:(0,C.Gm)(i)});return r}let useTableRowDeleteAllMutation=function(){let{onSuccess:e,onError:o,...n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,l.NL)();return(0,w.D)(e=>deleteAllTableRow(e),{async onSuccess(o,n,l){let{projectRef:i,table:a}=n;await t.invalidateQueries(b.M.query(i,[a.schema,a.name])),await (null==e?void 0:e(o,n,l))},async onError(e,n,t){void 0===o?r.Am.error("Failed to delete all table rows: ".concat(e.message)):o(e,n,t)},...n})};async function deleteTableRow(e){let{projectRef:o,connectionString:n,table:t,rows:l,impersonatedRole:i}=e,a=(0,p.Jh)(function(e){var o;let{table:n,rows:t}=e,{primaryKeys:l,error:i}=(0,j.h)({table:n});if(i)throw i;let a=new y.AE().from(n.name,null!==(o=n.schema)&&void 0!==o?o:void 0).delete();return l.forEach(e=>{let o=t.map(o=>o[e]);a=a.filter(e,"in",o)}),a.toSql()}({table:t,rows:l}),{projectRef:o,role:i}),{result:r}=await (0,D.Rj)({projectRef:o,connectionString:n,sql:a,isRoleImpersonationEnabled:(0,C.Gm)(i)});return r}let useTableRowDeleteMutation=function(){let{onSuccess:e,onError:o,...n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,l.NL)();return(0,w.D)(e=>deleteTableRow(e),{async onSuccess(o,n,l){let{projectRef:i,table:a}=n;await t.invalidateQueries(b.M.query(i,[a.schema,a.name])),await (null==e?void 0:e(o,n,l))},async onError(e,n,t){void 0===o?r.Am.error("Failed to delete table row: ".concat(e.message)):o(e,n,t)},...n})};async function truncateTableRow(e){let{projectRef:o,connectionString:n,table:t,impersonatedRole:l}=e,i=(0,p.Jh)(function(e){var o;let{table:n}=e;return new y.AE().from(n.name,null!==(o=n.schema)&&void 0!==o?o:void 0).truncate().toSql()}({table:t}),{projectRef:o,role:l}),{result:a}=await (0,D.Rj)({projectRef:o,connectionString:n,sql:i,isRoleImpersonationEnabled:(0,C.Gm)(l)});return a}let useTableRowTruncateMutation=function(){let{onSuccess:e,onError:o,...n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,l.NL)();return(0,w.D)(e=>truncateTableRow(e),{async onSuccess(o,n,l){let{projectRef:i,table:a}=n;await t.invalidateQueries(b.M.query(i,[a.schema,a.name])),await (null==e?void 0:e(o,n,l))},async onError(e,n,t){void 0===o?r.Am.error("Failed to truncate table row: ".concat(e.message)):o(e,n,t)},...n})};var S=n(33039),x=n(93969),T=n(666),N=n(89465),R=n(47095),A=n(44389),TableGridEditor_DeleteConfirmationDialogs=e=>{var o,n,i,w,y,D,p,j,E;let{projectRef:_,selectedTable:k,onAfterDeleteTable:q=R.ZT}=e,{meta:Z,ui:F}=(0,N.oR)(),L=(0,l.NL)(),{project:Q}=(0,v.d2)(),M=(0,A._2)(),[{filter:P},z]=(0,N.x3)({arrayKeys:["filter","sort"]}),I=(0,f.Yb)(P),W=(0,x.AF)({projectRef:null==Q?void 0:Q.ref,connectionString:null==Q?void 0:Q.connectionString}),{mutate:G}=useTableRowDeleteMutation({onSuccess:()=>{var e,o,n;(null===(e=M.confirmationDialog)||void 0===e?void 0:e.type)==="row"&&(null===(o=(n=M.confirmationDialog).callback)||void 0===o||o.call(n)),r.ZP.success("Successfully deleted selected row(s)"),M.closeConfirmationDialog()},onError:e=>{r.ZP.error("Failed to delete row: ".concat(e.message)),M.closeConfirmationDialog()}}),{mutateAsync:O}=useTableRowDeleteAllMutation({onSuccess:()=>{var e,o,n;(null===(e=M.confirmationDialog)||void 0===e?void 0:e.type)==="row"&&(null===(o=(n=M.confirmationDialog).callback)||void 0===o||o.call(n)),r.ZP.success("Successfully deleted selected rows"),M.closeConfirmationDialog()},onError:e=>{r.ZP.error("Failed to delete rows: ".concat(e.message)),M.closeConfirmationDialog()}}),{mutateAsync:B}=useTableRowTruncateMutation({onSuccess:()=>{var e,o,n;(null===(e=M.confirmationDialog)||void 0===e?void 0:e.type)==="row"&&(null===(o=(n=M.confirmationDialog).callback)||void 0===o||o.call(n)),r.ZP.success("Successfully deleted all rows from table"),M.closeConfirmationDialog()},onError:e=>{r.ZP.error("Failed to delete rows: ".concat(e.message)),M.closeConfirmationDialog()}}),J=(null===(o=M.confirmationDialog)||void 0===o?void 0:o.type)==="row"&&M.confirmationDialog.allRowsSelected,X=(null===(n=M.confirmationDialog)||void 0===n?void 0:n.type)==="row"?M.confirmationDialog.allRowsSelected?null!==(E=M.confirmationDialog.numRows)&&void 0!==E?E:0:M.confirmationDialog.rows.length:0,removeDeletedColumnFromFiltersAndSorts=e=>{z(o=>{var n,t;let l=null!==(n=null==o?void 0:o.filter)&&void 0!==n?n:[],i=null!==(t=null==o?void 0:o.sort)&&void 0!==t?t:[];return{...o,filter:l.filter(o=>{let[n]=o.split(":");if(n!==e)return o}),sort:i.filter(o=>{let[n]=o.split(":");if(n!==e)return o})}})},H=((null===(i=M.confirmationDialog)||void 0===i?void 0:i.type)==="column"||(null===(w=M.confirmationDialog)||void 0===w?void 0:w.type)==="table")&&M.confirmationDialog.isDeleteWithCascade,onConfirmDeleteColumn=async()=>{var e;if((null===(e=M.confirmationDialog)||void 0===e?void 0:e.type)!=="column")return;let o=M.confirmationDialog.column;try{if(void 0===o)return;let e=await Z.columns.del(o.id,H);if(e.error)throw e.error;removeDeletedColumnFromFiltersAndSorts(o.name),F.setNotification({category:"success",message:'Successfully deleted column "'.concat(o.name,'"')}),await Promise.all([L.invalidateQueries(b.M.query(null==Q?void 0:Q.ref,["foreign-key-constraints"])),L.invalidateQueries(S.W.table(null==Q?void 0:Q.ref,o.table_id)),L.invalidateQueries(b.M.query(null==Q?void 0:Q.ref,[k.schema,k.name])),L.invalidateQueries(b.M.query(null==Q?void 0:Q.ref,["table-definition",k.schema,k.name])),L.invalidateQueries(h.C.list(_)),M.selectedSchemaName?L.invalidateQueries(T.N.listBySchema(_,M.selectedSchemaName)):null,L.invalidateQueries(T.N.view(_,null==k?void 0:k.id))])}catch(e){F.setNotification({category:"error",message:"Failed to delete ".concat(o.name,": ").concat(e.message)})}finally{M.closeConfirmationDialog()}},onConfirmDeleteTable=async()=>{var e;if((null===(e=M.confirmationDialog)||void 0===e?void 0:e.type)==="table")try{if(void 0===k)return;let e=await Z.tables.del(k.id,H);if(e.error)throw e.error;let o=await W(M.selectedSchemaName);await Promise.all([L.invalidateQueries(h.C.list(_)),M.selectedSchemaName?L.invalidateQueries(T.N.listBySchema(_,M.selectedSchemaName)):null,L.invalidateQueries(T.N.view(_,null==k?void 0:k.id))]),q(o),F.setNotification({category:"success",message:'Successfully deleted table "'.concat(k.name,'"')})}catch(e){F.setNotification({error:e,category:"error",message:"Failed to delete ".concat(null==k?void 0:k.name,": ").concat(e.message)})}finally{M.closeConfirmationDialog()}},K=(0,C.z6)(),onConfirmDeleteRow=async()=>{var e;if(!Q)return console.error("Project ref is required");if(!k)return console.error("Selected table required");if((null===(e=M.confirmationDialog)||void 0===e?void 0:e.type)!=="row")return;let o=M.confirmationDialog.rows;M.confirmationDialog.allRowsSelected?0===I.length?B({projectRef:Q.ref,connectionString:Q.connectionString,table:k,impersonatedRole:K()}):O({projectRef:Q.ref,connectionString:Q.connectionString,table:k,filters:I,impersonatedRole:K()}):G({projectRef:Q.ref,connectionString:Q.connectionString,table:k,rows:o,impersonatedRole:K()})};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(g.Z,{danger:!0,size:"small",visible:(null===(y=M.confirmationDialog)||void 0===y?void 0:y.type)==="column",header:'Confirm deletion of column "'.concat((null===(D=M.confirmationDialog)||void 0===D?void 0:D.type)==="column"&&M.confirmationDialog.column.name,'"'),buttonLabel:"Delete",buttonLoadingLabel:"Deleting",onSelectCancel:()=>{M.closeConfirmationDialog()},onSelectConfirm:onConfirmDeleteColumn,children:(0,t.jsx)(s.C.Content,{children:(0,t.jsxs)("div",{className:"py-4 space-y-4",children:[(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"Are you sure you want to delete the selected column? This action cannot be undone."}),(0,t.jsx)(c.Z,{label:"Drop column with cascade?",description:"Deletes the column and its dependent objects",checked:H,onChange:()=>M.toggleConfirmationIsWithCascade()}),H&&(0,t.jsxs)(d.b,{withIcon:!0,variant:"warning",title:"Warning: Dropping with cascade may result in unintended consequences",children:[(0,t.jsx)("p",{className:"mb-4",children:"All dependent objects will be removed, as will any objects that depend on them, recursively."}),(0,t.jsx)(u.z,{asChild:!0,size:"tiny",type:"default",icon:(0,t.jsx)(m.Z,{}),children:(0,t.jsx)(a(),{href:"https://www.postgresql.org/docs/current/ddl-depend.html",target:"_blank",rel:"noreferrer",children:"About dependency tracking"})})]})]})})}),(0,t.jsx)(g.Z,{danger:!0,size:"small",visible:(null===(p=M.confirmationDialog)||void 0===p?void 0:p.type)==="table",header:(0,t.jsx)("span",{className:"break-words",children:'Confirm deletion of table "'.concat(null==k?void 0:k.name,'"')}),buttonLabel:"Delete",buttonLoadingLabel:"Deleting",onSelectCancel:()=>{M.closeConfirmationDialog()},onSelectConfirm:onConfirmDeleteTable,children:(0,t.jsx)(s.C.Content,{children:(0,t.jsxs)("div",{className:"py-4 space-y-4",children:[(0,t.jsx)("p",{className:"text-sm text-foreground-light",children:"Are you sure you want to delete the selected table? This action cannot be undone."}),(0,t.jsx)(c.Z,{label:"Drop table with cascade?",description:"Deletes the table and its dependent objects",checked:H,onChange:()=>M.toggleConfirmationIsWithCascade(!H)}),H&&(0,t.jsxs)(d.b,{withIcon:!0,variant:"warning",title:"Warning: Dropping with cascade may result in unintended consequences",children:[(0,t.jsx)("p",{className:"mb-4",children:"All dependent objects will be removed, as will any objects that depend on them, recursively."}),(0,t.jsx)(u.z,{asChild:!0,size:"tiny",type:"default",icon:(0,t.jsx)(m.Z,{}),children:(0,t.jsx)(a(),{href:"https://www.postgresql.org/docs/current/ddl-depend.html",target:"_blank",rel:"noreferrer",children:"About dependency tracking"})})]})]})})}),(0,t.jsx)(g.Z,{danger:!0,size:"small",visible:(null===(j=M.confirmationDialog)||void 0===j?void 0:j.type)==="row",header:(0,t.jsxs)("span",{className:"break-words",children:["Confirm to delete the selected row",X>1&&"s"]}),buttonLabel:"Delete",buttonLoadingLabel:"Deleting",onSelectCancel:()=>M.closeConfirmationDialog(),onSelectConfirm:()=>onConfirmDeleteRow(),children:(0,t.jsx)(s.C.Content,{children:(0,t.jsx)("div",{className:"py-4 space-y-4",children:(0,t.jsxs)("p",{className:"text-sm text-foreground-light",children:["Are you sure you want to delete ",J?"all":"the selected"," ",X>1&&"".concat(X," "),"row",X>1&&"s","? This action cannot be undone."]})})})})]})}},40072:function(e,o,n){"use strict";n.r(o);var t=n(52322),l=n(60674),i=n(2784),a=n(69954),r=n(48271),s=n(51343),c=n(51373),d=n(34278),u=n(44389);let DatabaseTables=()=>{let{ref:e}=(0,l.UO)(),o=(0,u._2)(),[n,c]=(0,i.useState)(),[m,f]=(0,i.useState)();return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(d._S,{children:(0,t.jsx)(d.jX,{children:(0,t.jsx)("div",{className:"col-span-12",children:void 0===n?(0,t.jsx)(a.bw,{onAddTable:o.onAddTable,onEditTable:e=>{f(e),o.onEditTable()},onDeleteTable:e=>{f(e),o.onDeleteTable()},onOpenTable:c}):(0,t.jsx)(a.TH,{table:n,onAddColumn:o.onAddColumn,onEditColumn:o.onEditColumn,onDeleteColumn:o.onDeleteColumn,onSelectBack:()=>c(void 0)})})})}),(0,t.jsx)(s.Z,{projectRef:e,selectedTable:m}),(0,t.jsx)(r.l5,{selectedTable:n||m})]})};DatabaseTables.getLayout=e=>(0,t.jsx)(c._h,{title:"Database",children:e}),o.default=DatabaseTables}},function(e){e.O(0,[6139,1715,1187,6653,3844,8421,9362,4796,806,2591,4019,1971,3614,6782,6028,1915,4079,4964,8211,452,8108,2223,4978,9954,8271,9774,2888,179],function(){return e(e.s=2112)}),_N_E=e.O()}]);