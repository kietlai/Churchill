(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6377],{98528:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/project/[ref]/sql/[id]",function(){return n(90309)}])},43877:function(e,t,n){"use strict";n.d(t,{B:function(){return s},Y4:function(){return a},dA:function(){return o},nK:function(){return r},q_:function(){return d}});var i=n(46732);let r=660,a=50,s=20,l={SOUTHEAST_ASIA:[103.8,1.37],NORTHEAST_ASIA:[139.42,35.41],NORTHEAST_ASIA_2:[126.98,37.56],CENTRAL_CANADA:[-73.6,45.5],WEST_US:[-121.96,37.35],EAST_US:[-78.45,38.13],WEST_EU:[-8,53],WEST_EU_2:[-.1,51],CENTRAL_EU:[8,50],SOUTH_ASIA:[72.88,19.08],OCEANIA:[151.2,-33.86],SOUTH_AMERICA:[-46.38,-23.34]},o={SOUTHEAST_ASIA:"ap-southeast-1",NORTHEAST_ASIA:"ap-northeast-1",NORTHEAST_ASIA_2:"ap-northeast-2",CENTRAL_CANADA:"ca-central-1",WEST_US:"us-west-1",EAST_US:"es-east-1",WEST_EU:"eu-west-1",WEST_EU_2:"eu-west-2",CENTRAL_EU:"eu-central-1",SOUTH_ASIA:"ap-south-1",OCEANIA:"ap-southeast-2",SOUTH_AMERICA:"sa-east-1"},d=Object.keys(i.Wp).map(e=>({key:e,name:i.Wp[e],region:o[e],coordinates:l[e]})).filter(e=>void 0!==e.coordinates)},35322:function(e,t,n){"use strict";var i=n(87612);t.Z=class{hasNext(){return this.lineNumber>=0||this.offset>=0}isFowardDQuote(){return!!this.hasForward()&&34===this.peekForward()}isNextDQuote(){return!!this.hasNext()&&34===this.peekNext()}isNextPeriod(){return!!this.hasNext()&&46===this.peekNext()}peekNext(){return this.offset<0?this.lineNumber>0?10:0:this._line.charCodeAt(this.offset)}hasForward(){return this.lineNumber<this._lines.length||this.offset<this._line.length}peekForward(){return this.offset===this._line.length?this.lineNumber===this._lines.length?0:10:this._line.charCodeAt(this.offset+1)}next(){if(this.offset<0)return this.lineNumber>0?(this.lineNumber--,this._line=this._lines[this.lineNumber],this.offset=this._line.length-1,10):(this.lineNumber=-1,0);let e=this._line.charCodeAt(this.offset);return this.offset--,e}readArguments(){let e=0,t=0,n=0,i=0;for(;this.hasNext();){let r=this.next();switch(r){case 40:if(--e<0)return i;break;case 41:e++;break;case 123:n--;break;case 125:n++;break;case 91:t--;break;case 93:t++;break;case 34:case 39:for(;this.hasNext()&&r!==this.next(););break;case 44:!e&&!t&&!n&&i++}}return -1}readIdent(){let e=!1,t=!1,n="";for(;this.hasNext();){let i=this.peekNext();if(e&&!t&&!this._isIdentPart(i))break;if(i=this.next(),!e&&t&&34===i){e=!0;continue}if(e||32!==i&&9!==i&&10!=i){if(!e&&(34===i||this._isIdentPart(i)))e=!0,t=34===i,n=String.fromCharCode(i)+n;else if(e){if(t){if(0===i||(n=String.fromCharCode(i)+n,34===i))break}else n=String.fromCharCode(i)+n}}}return n}readIdents(e){let t=[];for(;e>0;){e--;let n=this.readIdent();if(!n||(t.push(n),!this.isNextPeriod()))break}return t.reverse()}_isIdentPart(e){return 95===e||e>=97&&e<=122||e>=65&&e<=90||e>=48&&e<=57}constructor(e,t,n){(0,i._)(this,"_line",void 0),(0,i._)(this,"_text",void 0),(0,i._)(this,"_lines",void 0),(0,i._)(this,"model",void 0),(0,i._)(this,"offset",void 0),(0,i._)(this,"lineNumber",void 0),this.model=e,this.offset=t,this.lineNumber=n,this._text=e.getValue(),this._lines=this._text.split(/\r?\n/g),this._line=this._lines[n]}}},13623:function(e,t,n){"use strict";var i=n(52322),r=n(39097),a=n.n(r),s=n(5632),l=n(2784),o=n(60674),d=n(66202),c=n(8191),u=n(33684),m=n(56469),p=n(94580),f=n(4220),g=n(43502),h=n(50671),v=n(50138),x=n(55216),b=n(88058);t.Z=e=>{var t;let{variant:n="regular"}=e,r=(0,s.useRouter)(),{ref:y}=(0,o.UO)(),[j,_]=(0,l.useState)(!1),N=(0,u.TF)(),S=N.selectedDatabaseId,{data:E}=(0,d.b)({projectRef:y}),w=null!=E?E:[],C=w.find(e=>e.identifier===S),k=(0,c.f)(null!==(t=null==C?void 0:C.region)&&void 0!==t?t:""),R=(0,c.U)(null!=S?S:"");return(0,i.jsxs)(m.J2,{open:j,onOpenChange:_,modal:!1,children:[(0,i.jsx)(m.xo,{asChild:!0,children:(0,i.jsx)("div",{className:"flex items-center space-x-2 cursor-pointer",children:(0,i.jsxs)(p.z,{type:"default",className:(0,f.cn)("pr-2","connected-on-right"===n&&"rounded-r-none","connected-on-left"===n&&"rounded-l-none border-l-0","connected-on-both"===n&&"rounded-none border-x-0"),iconRight:(0,i.jsx)(g.Z,{className:"text-foreground-light",strokeWidth:2,size:12}),children:["Source:"," ",(0,i.jsx)("span",{className:"capitalize",children:(null==C?void 0:C.identifier)===y?"Primary database":"Read replica"})," ",(null==C?void 0:C.identifier)!==y&&(0,i.jsxs)("span",{children:["(",k," - ",R,")"]})]})})}),(0,i.jsx)(m.yk,{className:"p-0 w-64",side:"bottom",align:"end",children:(0,i.jsx)(h.mY,{children:(0,i.jsxs)(h.e8,{children:[(0,i.jsx)(h.fu,{children:(0,i.jsx)(v.x,{className:(w||[]).length>7?"h-[210px]":"",children:null==w?void 0:w.map(e=>{let t=(0,c.f)(e.region),n=(0,c.U)(e.identifier);return(0,i.jsx)(h.di,{value:e.identifier,className:"cursor-pointer w-full",onSelect:()=>{N.setSelectedDatabaseId(e.identifier),_(!1)},onClick:()=>{N.setSelectedDatabaseId(e.identifier),_(!1)},children:(0,i.jsxs)("div",{className:"w-full flex items-center justify-between",children:[(0,i.jsx)("p",{children:e.identifier===y?"Primary database":"Read replica (".concat(t," - ").concat(n,")")}),e.identifier===S&&(0,i.jsx)(x.Z,{})]})},e.identifier)})})}),(0,i.jsx)(h.fu,{className:"border-t",children:(0,i.jsx)(h.di,{className:"cursor-pointer w-full",onSelect:()=>{_(!1),r.push("/project/".concat(y,"/settings/infrastructure"))},onClick:()=>_(!1),children:(0,i.jsxs)(a(),{href:"/project/".concat(y,"/settings/infrastructure"),onClick:()=>{_(!1)},className:"w-full flex items-center gap-2",children:[(0,i.jsx)(b.Z,{size:14,strokeWidth:1.5}),(0,i.jsx)("p",{children:"Create a new read replica"})]})})})]})})})]})}},15873:function(e,t,n){"use strict";n.d(t,{V:function(){return useSqlDebugMutation}});var i=n(62350),r=n(62202),a=n(3218),s=n(46732);async function debugSql(e){let{errorMessage:t,sql:n,entityDefinitions:i}=e,r=await (0,a.v_)(s.GW+"/api/ai/sql/debug",{errorMessage:t,sql:n,entityDefinitions:i});if(!(0,a.d8)(r))throw r.error;return r}let useSqlDebugMutation=function(){let{onSuccess:e,onError:t,...n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,i.D)(e=>debugSql(e),{async onSuccess(t,n,i){await (null==e?void 0:e(t,n,i))},async onError(e,n,i){void 0===t?r.ZP.error("Failed to debug SQL: ".concat(e.message)):t(e,n,i)},...n})}},39443:function(e,t,n){"use strict";n.d(t,{K:function(){return useTableColumnsQuery}});var i=n(70481);let getTableColumnsQuery=(e,t)=>{let n=[];e&&n.push("tablename = '".concat(e,"'")),t&&n.push("schemaname = '".concat(t,"'"));let i=n.length>0?"WHERE ".concat(n.join(" AND ")):"",r="\n  \n  SELECT\n    tbl.schemaname,\n    tbl.tablename,\n    tbl.quoted_name,\n    tbl.is_table,\n    json_agg(a) as columns\n  FROM\n    (\n      SELECT\n        n.nspname as schemaname,\n        c.relname as tablename,\n        (quote_ident(n.nspname) || '.' || quote_ident(c.relname)) as quoted_name,\n        true as is_table\n      FROM\n        pg_catalog.pg_class c\n        JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\n      WHERE\n        c.relkind = 'r'\n        AND n.nspname not in ('information_schema', 'pg_catalog', 'pg_toast')\n        AND n.nspname not like 'pg_temp_%'\n        AND n.nspname not like 'pg_toast_temp_%'\n        AND has_schema_privilege(n.oid, 'USAGE') = true\n        AND has_table_privilege(quote_ident(n.nspname) || '.' || quote_ident(c.relname), 'SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER') = true\n      union all\n      SELECT\n        n.nspname as schemaname,\n        c.relname as tablename,\n        (quote_ident(n.nspname) || '.' || quote_ident(c.relname)) as quoted_name,\n        false as is_table\n      FROM\n        pg_catalog.pg_class c\n        JOIN pg_catalog.pg_namespace n ON n.oid = c.relnamespace\n      WHERE\n        c.relkind in ('v', 'm')\n        AND n.nspname not in ('information_schema', 'pg_catalog', 'pg_toast')\n        AND n.nspname not like 'pg_temp_%'\n        AND n.nspname not like 'pg_toast_temp_%'\n        AND has_schema_privilege(n.oid, 'USAGE') = true\n        AND has_table_privilege(quote_ident(n.nspname) || '.' || quote_ident(c.relname), 'SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER') = true\n    ) as tbl\n    LEFT JOIN (\n      SELECT\n        attrelid,\n        attname,\n        format_type(atttypid, atttypmod) as data_type,\n        attnum,\n        attisdropped\n      FROM\n        pg_attribute\n    ) as a ON (\n      a.attrelid = tbl.quoted_name::regclass\n      AND a.attnum > 0\n      AND NOT a.attisdropped\n      AND has_column_privilege(tbl.quoted_name, a.attname, 'SELECT, INSERT, UPDATE, REFERENCES')\n    )\n  ".concat(i,"\n  GROUP BY schemaname, tablename, quoted_name, is_table;\n").trim();return r},useTableColumnsQuery=function(e){let{projectRef:t,connectionString:n,table:r,schema:a}=e,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,i.cp)({projectRef:t,connectionString:n,sql:getTableColumnsQuery(r,a),queryKey:["table-columns",a,r]},s)}},44782:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});let i={list:e=>["project",e,"replicas"],statuses:e=>["project",e,"replicas-statuses"]}},66202:function(e,t,n){"use strict";n.d(t,{b:function(){return useReadReplicasQuery}});var i=n(58943),r=n(9402),a=n(44782),s=n(89465),l=n(60496);async function getReadReplicas(e,t){let{projectRef:n}=e;if(!n)throw Error("Project ref is required");let{data:i,error:a}=await (0,r.U2)("/platform/projects/{ref}/databases",{params:{path:{ref:n}},signal:t});if(a)throw a;return i}let useReadReplicasQuery=function(e){let{projectRef:t}=e,{enabled:n=!0,...r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=(0,s.P5)("readReplicas"),{data:d}=(0,l.ix)({ref:t});return(0,i.a)(a.Z.list(t),e=>{let{signal:n}=e;return getReadReplicas({projectRef:t},n)},{enabled:n&&(null==d?void 0:d.is_read_replicas_enabled)&&o&&void 0!==t,...r})}},8191:function(e,t,n){"use strict";n.d(t,{U:function(){return formatDatabaseID},f:function(){return formatDatabaseRegion}});var i=n(43877),r=n(56974),a=n.n(r);let formatDatabaseID=e=>{var t;return a()(null!==(t=e.split("-"))&&void 0!==t?t:[])},formatDatabaseRegion=e=>{var t,n;return null===(t=a()(null===(n=i.q_.find(t=>t.region===e))||void 0===n?void 0:n.name.split("(")))||void 0===t?void 0:t.split(")")[0]}},38488:function(e,t,n){"use strict";n.d(t,{r:function(){return useExecuteSqlMutation}});var i=n(62202),r=n(62350),a=n(70481);let useExecuteSqlMutation=function(){let{onSuccess:e,onError:t,...n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,r.D)(e=>(0,a.Rj)(e),{async onSuccess(t,n,i){await (null==e?void 0:e(t,n,i))},async onError(e,n,r){void 0===t?i.Am.error("Failed to execute SQL: ".concat(e.message)):t(e,n,r)},...n})}},90309:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return eU}});var i=n(52322),r=n(5632),a=n(79534),s=n(46776),l=n(2784),o=n(60674),d=n(70481);let getFunctionsQuery=()=>"\nSELECT n.nspname as \"schema\",\n  p.proname as \"name\",\n  d.description,\n  pg_catalog.pg_get_function_result(p.oid) as \"result_type\",\n  pg_catalog.pg_get_function_arguments(p.oid) as \"argument_types\",\nCASE\n  WHEN p.prokind = 'a' THEN 'agg'\n  WHEN p.prokind = 'w' THEN 'window'\n  WHEN p.prorettype = 'pg_catalog.trigger'::pg_catalog.regtype THEN 'trigger'\n  ELSE 'normal'\n  END as \"type\"\nFROM pg_catalog.pg_proc p\n  LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace\n  LEFT JOIN pg_catalog.pg_description d ON p.oid = d.objoid\nWHERE n.nspname = 'public'\nORDER BY 1, 2, 4;\n".trim(),useFunctionsQuery=function(e){let{projectRef:t,connectionString:n}=e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,d.cp)({projectRef:t,connectionString:n,sql:getFunctionsQuery(),queryKey:["functions"]},{select:e=>({result:e.result.map(e=>{let t=e.argument_types.split(",").filter(e=>e).map(e=>e.trim());return{...e,args:t}})}),...i})},getKeywordsQuery=()=>"\nSELECT word FROM pg_get_keywords();\n".trim(),useKeywordsQuery=function(e){let{projectRef:t,connectionString:n}=e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,d.cp)({projectRef:t,connectionString:n,sql:getKeywordsQuery(),queryKey:["keywords"]},{select:e=>({result:e.result.map(e=>e.word.toLocaleLowerCase())}),...i})};var c=n(12752),u=n(39443),m=n(62350),p=n(3218),f=n(46732);async function formatQuery(e,t){let{projectRef:n,connectionString:i,sql:r}=e,a=new Headers;i&&a.set("x-connection-encrypted",i);let s=await (0,p.v_)("".concat(f.T5,"/pg-meta/").concat(n,"/query/format"),{query:r},{headers:Object.fromEntries(a),signal:t});if(s.error)throw s.error;return{result:s}}let useFormatQueryMutation=function(){let{onSuccess:e,...t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,m.D)(e=>formatQuery(e),{async onSuccess(t,n,i){await (null==e?void 0:e(t,n,i))},...t})};var g=n(82841),h=n(94589),v=n(25237),x=n.n(v),b=n(40578),y=n(36782),j=n(33461),_=n(62202);async function editSql(e){let{prompt:t,sql:n,entityDefinitions:i}=e,r=await (0,p.v_)(f.GW+"/api/ai/sql/edit",{prompt:t,sql:n,entityDefinitions:i});if(!(0,p.d8)(r))throw r.error;return r}let useSqlEditMutation=function(){let{onSuccess:e,onError:t,...n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,m.D)(e=>editSql(e),{async onSuccess(t,n,i){await (null==e?void 0:e(t,n,i))},async onError(e,n,i){void 0===t?_.ZP.error("Failed to edit SQL: ".concat(e.message)):t(e,n,i)},...n})};async function generateSql(e){let{prompt:t,entityDefinitions:n}=e,i=await (0,p.v_)(f.GW+"/api/ai/sql/generate",{prompt:t,entityDefinitions:n});if(!(0,p.d8)(i))throw i.error;return i}let useSqlGenerateMutation=function(){let{onSuccess:e,onError:t,...n}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,m.D)(e=>generateSql(e),{async onSuccess(t,n,i){await (null==e?void 0:e(t,n,i))},async onError(e,n,i){void 0===t?_.ZP.error("Failed to generate SQL: ".concat(e.message)):t(e,n,i)},...n})};var N=n(3152),S=n(78961),E=n(66202),w=n(38488),C=n(21511),k=n(56424),R=n(89465),A=n(71813),q=n(84447),T=n(74915),I=n(96689),L=n(64439),D=n(33684),U=n(11033),P=n(87082),F=n(4220),Q=n(9839),z=n(84283),Z=n(94580),O=n(55216),M=n(13781),W=n(1863),V=n(97036),H=n(43502),K=n(88979),G=n(71164),$=n(8957),J=n(13844),Y=n(3689),SQLEditor_AISchemaSuggestionPopover=e=>{var t,n;let{children:r,delay:a=300,onClickSettings:s}=e,o=(0,R.lL)(),d=null!==(n=null==o?void 0:null===(t=o.opt_in_tags)||void 0===t?void 0:t.includes(f.PV.AI_SQL))&&void 0!==n&&n,[c]=(0,R.ly)("supabase_sql-editor-ai-schema",!0),[u,m]=(0,l.useState)(!1),[p]=(0,R.ly)("supabase_sql-editor-ai-query-count",0),h=(d||!f.Qy)&&c,[v,x]=(0,R.ly)("supabase_sql-editor-ai-schema-suggestion-dismissed",!1);return(0,l.useEffect)(()=>{let e=window.setTimeout(()=>{m(!0)},a);return()=>window.clearTimeout(e)}),(0,i.jsxs)(J.fC,{open:u&&!h&&p>=3&&!v,children:[(0,i.jsx)(J.ee,{asChild:!0,children:r}),(0,i.jsx)(J.h_,{children:(0,i.jsx)(J.VY,{side:"bottom",sideOffset:5,children:(0,i.jsxs)(g.E.div,{variants:{visible:{opacity:1,y:0},hidden:{opacity:0,y:-10}},initial:"hidden",animate:"visible",children:[(0,i.jsx)(J.Eh,{className:"fill-background-surface-300"}),(0,i.jsxs)("div",{className:"flex flex-col gap-2 border border-default rounded-md p-4 bg-surface-100 shadow-xl",children:[(0,i.jsxs)("div",{className:"flex flex-row items-center gap-4 max-w-md",children:[(0,i.jsx)(Y.Z,{className:"w-6 h-6"}),(0,i.jsx)("p",{className:"text-sm",children:"Generate more relevant queries by including database metadata in your requests."})]}),(0,i.jsxs)("div",{className:"flex flex-row gap-2 justify-end",children:[(0,i.jsx)(Z.z,{type:"default",onClick:()=>{x(!0)},children:"Dismiss"}),(0,i.jsx)(Z.z,{onClick:()=>{x(!0),null==s||s()},children:"Open settings"})]})]})]})})})]})},B=n(55345),X=n(91),ee=n(32392),et=n(2755),en=n(60417),ei=n.n(en),er=n(29259),ea=n.n(er),es=n(85505),el=n.n(es),eo=n(16760),ed=n.n(eo),ec=n(83606),eu=n(46469),em=n(49097),ep=n(17591),ef=n.n(ep),UtilityPanel_ResultsDropdown=e=>{var t,n,a,s;let{id:d,isExecuting:c}=e,{project:u}=(0,et.d2)(),m=(0,P.W2)(),p=(0,o.Mk)(),f=null!==(s=null===(n=m.results)||void 0===n?void 0:null===(t=n[d])||void 0===t?void 0:t[0])&&void 0!==s?s:void 0,{ui:g}=(0,R.oR)(),h=(0,l.useRef)(null),v=(0,r.useRouter)(),x=(0,l.useMemo)(()=>{if(null==f?void 0:f.rows){let e=Array.from(f.rows||[]).map(e=>ed()(e,(e,t)=>el()(e)?e.replaceAll(/\n/g,"\\n").replaceAll(/"/g,'""'):ea()(e)?JSON.stringify(e).replaceAll(/\"/g,'""'):e));return ei()(e)}return""},[f]),b=(0,l.useMemo)(()=>{if(null==f?void 0:f.rows){let e=Array.from(f.rows||[])[0];if(e)return Object.keys(e)}},[f]);return(0,i.jsxs)(V.h_,{children:[(0,i.jsx)(V.$F,{asChild:!0,children:(0,i.jsx)(Z.z,{type:"text",iconRight:(0,i.jsx)(H.Z,{}),children:(0,i.jsxs)("span",{children:["Results",!c&&f&&f.rows.length>0&&" (".concat(f.rows.length.toLocaleString(),")")]})})}),(0,i.jsx)(ec.CSVLink,{ref:h,className:"hidden",headers:b,data:x,filename:"supabase_".concat(null==u?void 0:u.ref,"_").concat(null===(a=m.snippets[d])||void 0===a?void 0:a.snippet.name,".csv")}),(0,i.jsx)(V.AW,{side:"bottom",align:"start",children:(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(V.Xi,{onClick:function(){var e;null===(e=h.current)||void 0===e||e.link.click(),I.Z.sendEvent({category:"sql_editor",action:"sql_download_csv",label:""},p,v)},className:"space-x-2",children:[(0,i.jsx)(eu.Z,{size:"tiny"}),(0,i.jsx)("p",{children:"Download CSV"})]}),(0,i.jsxs)(V.Xi,{onClick:function(){if(navigator){if(!f||!f.rows)return"results is empty";if(f.rows.constructor!==Array&&f.error)return f.error;if(0==f.rows.length)return"results is empty";let e=Object.keys(f.rows[0]),t=f.rows.map(t=>{let n=[];return e.forEach(e=>n.push(t[e])),n}),n=[e].concat(t),i=ef()(n);(0,A.vQ)(i,()=>{g.setNotification({category:"success",message:"Copied results to clipboard"}),I.Z.sendEvent({category:"sql_editor",action:"sql_copy_as_markdown",label:""},p,v)})}},className:"space-x-2",children:[(0,i.jsx)(em.Z,{size:"tiny"}),(0,i.jsx)("p",{children:"Copy as markdown"})]})]})})]})},eg=n(24990),eh=n(83359),ev=n(91992),ex=n(2894),eb=n(13623),ey=n(26483),ej=n(55830),e_=n(13080),UtilityPanel_FavoriteButton=e=>{let{id:t}=e,n=(0,ej.NL)(),{project:r}=(0,et.d2)(),a=(0,P.W2)(),s=a.snippets[t],l=void 0!==s&&s.snippet.content.favorite;async function addFavorite(){a.addFavorite(t),n.setQueryData(e_.$.list(null==r?void 0:r.ref),e=>{if(e)return{...e,content:e.content.map(e=>"sql"===e.type&&e.id===t?{...e,content:{...e.content,favorite:!0}}:e)}})}async function removeFavorite(){a.removeFavorite(t),n.setQueryData(e_.$.list(null==r?void 0:r.ref),e=>{if(e)return{...e,content:e.content.map(e=>"sql"===e.type&&e.id===t?{...e,content:{...e.content,favorite:!1}}:e)}})}return(0,i.jsx)(i.Fragment,{children:l?(0,i.jsx)(Z.z,{type:"text",size:"tiny",onClick:removeFavorite,icon:(0,i.jsx)(ey.Z,{size:"tiny",fill:"#48bb78"})}):(0,i.jsx)(Z.z,{type:"text",size:"tiny",onClick:addFavorite,icon:(0,i.jsx)(ey.Z,{size:"tiny",fill:"gray"})})})},eN=n(82462),eS=n(97265),IconRefreshCcw_IconRefreshCcw=function(e){return(0,i.jsx)(eS.Z,{icon:eN.Z,...e})},eE=n(39195),ew=n(84959),UtilityPanel_ReadOnlyBadge=e=>{var t,n,r;let{id:a}=e,s=(0,o.aF)(),l=(0,P.W2)(),d=l.snippets[a],c=(null==s?void 0:null===(t=s.user_metadata)||void 0===t?void 0:t.user_name)===(null==d?void 0:null===(r=d.snippet)||void 0===r?void 0:null===(n=r.owner)||void 0===n?void 0:n.username);return(0,i.jsx)(i.Fragment,{children:c?null:(0,i.jsx)(ew.Z,{color:"gray",children:"Read-only"})})},UtilityPanel_SavingIndicator=e=>{var t,n,r;let{id:a}=e,s=(0,P.W2)(),d=s.savingStates[a],c=(0,o.aF)(),u=(0,R.D9)(d),[m,p]=(0,l.useState)(!1),f=s.snippets[a],g=(null==c?void 0:null===(t=c.user_metadata)||void 0===t?void 0:t.user_name)===(null==f?void 0:null===(r=f.snippet)||void 0===r?void 0:null===(n=r.owner)||void 0===n?void 0:n.username);return(0,l.useEffect)(()=>{let e=!1;return"UPDATING"===u&&"IDLE"===d&&(p(!0),setTimeout(()=>{e||p(!1)},3e3)),()=>{e=!0}},[d]),(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)("div",{className:"mx-2 flex items-center gap-2",children:[g&&"UPDATING_FAILED"===d&&(0,i.jsx)(Z.z,{type:"text",size:"tiny",icon:(0,i.jsx)(IconRefreshCcw_IconRefreshCcw,{className:"text-gray-1100",size:"tiny",strokeWidth:2}),onClick:()=>{s.addNeedsSaving(a)},children:"Retry"}),m?(0,i.jsxs)(eg.fC,{delayDuration:0,children:[(0,i.jsx)(eg.xz,{children:(0,i.jsx)(O.Z,{className:"text-brand",size:14,strokeWidth:3})}),(0,i.jsxs)(eg.VY,{side:"bottom",children:[(0,i.jsx)(eg.Eh,{className:"radix-tooltip-arrow"}),(0,i.jsx)("div",{className:"bg-alternative rounded py-1 px-2 leading-none shadow border-background border ",children:(0,i.jsx)("span",{className:"text-foreground text-xs",children:"All changes saved"})})]})]}):g&&"UPDATING"===d?(0,i.jsxs)(eg.fC,{delayDuration:0,children:[(0,i.jsx)(eg.xz,{children:(0,i.jsx)(M.Z,{className:"animate-spin",size:14,strokeWidth:2})}),(0,i.jsxs)(eg.VY,{side:"bottom",children:[(0,i.jsx)(eg.Eh,{className:"radix-tooltip-arrow"}),(0,i.jsx)("div",{className:"bg-alternative rounded py-1 px-2 leading-none shadow border-background border",children:(0,i.jsx)("span",{className:"text-foreground text-xs",children:"Saving changes..."})})]})]}):"UPDATING_FAILED"===d?g?(0,i.jsxs)(eg.fC,{delayDuration:0,children:[(0,i.jsx)(eg.xz,{children:(0,i.jsx)(eE.Z,{className:"text-red-900",size:14,strokeWidth:2})}),(0,i.jsxs)(eg.VY,{side:"bottom",children:[(0,i.jsx)(eg.Eh,{className:"radix-tooltip-arrow"}),(0,i.jsx)("div",{className:"bg-alternative rounded py-1 px-2 leading-none shadow border-background border ",children:(0,i.jsx)("span",{className:"text-foreground text-xs",children:"Failed to save changes"})})]})]}):(0,i.jsx)(UtilityPanel_ReadOnlyBadge,{id:a}):null]})})},UtilityPanel_UtilityActions=e=>{let{id:t,isExecuting:n=!1,isDisabled:r=!1,hasSelection:a,prettifyQuery:s,executeQuery:l}=e,o=(0,A.fV)(),d=(0,R.Vm)(),c=(0,R.P5)("readReplicas"),u=c&&(null==d?void 0:d.is_read_replicas_enabled);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(UtilityPanel_SavingIndicator,{id:t}),f.Qy&&(0,i.jsx)(UtilityPanel_FavoriteButton,{id:t}),(0,i.jsxs)(eg.fC,{delayDuration:0,children:[(0,i.jsx)(eg.xz,{asChild:!0,children:(0,i.jsx)(Z.z,{type:"text",onClick:()=>s(),icon:(0,i.jsx)(eh.Z,{size:"tiny",strokeWidth:2,className:"text-gray-1100"})})}),(0,i.jsx)(eg.h_,{children:(0,i.jsxs)(eg.VY,{side:"bottom",children:[(0,i.jsx)(eg.Eh,{className:"radix-tooltip-arrow"}),(0,i.jsx)("div",{className:"rounded bg-alternative py-1 px-2 leading-none shadow border border-background",children:(0,i.jsx)("span",{className:"text-xs text-foreground",children:"Prettify SQL"})})]})})]}),(0,i.jsx)("div",{className:"flex items-center justify-between gap-x-2 mx-2",children:(0,i.jsxs)("div",{className:"flex items-center",children:[u&&(0,i.jsx)(eb.Z,{variant:"connected-on-right"}),(0,i.jsx)(ex.Q,{serviceRoleLabel:"postgres",variant:u?"connected-on-both":"connected-on-right"}),(0,i.jsx)(Z.z,{onClick:()=>l(),disabled:r||n,loading:n,type:"primary",size:"tiny",iconRight:(0,i.jsxs)("div",{className:"flex items-center space-x-1",children:["macos"===o?(0,i.jsx)(ev.Z,{size:10,strokeWidth:1.5}):(0,i.jsx)("p",{className:"text-xs text-foreground-light",children:"CTRL"}),(0,i.jsx)(W.Z,{size:10,strokeWidth:1.5})]}),className:"rounded-l-none",children:a?"Run selected":"Run"})]})})]})},eC=n(15873),ek=n(71623),eR=n(47370),eA=n(28316),UtilityPanel_Results=e=>{var t;let{id:n,rows:r}=e,a="sql-context-menu-"+n,[s,o]=(0,l.useState)(void 0);function onCopyCell(){if(s){var e,t;let{rowIdx:n,column:i}=s,a=i.key,l=null!==(t=null===(e=r[n])||void 0===e?void 0:e[a])&&void 0!==t?t:"",o=null===l?"":"object"==typeof l||Array.isArray(l)?JSON.stringify(l):l;(0,A.vQ)(o)}}(0,R.aL)({"Command+c":e=>{e.stopPropagation(),onCopyCell()},"Control+c":e=>{e.stopPropagation(),onCopyCell()}},["INPUT","TEXTAREA"]);let{show:d}=(0,ek.av)(),formatter=(e,t)=>(0,i.jsx)("span",{className:"font-mono text-xs w-full",onContextMenu:e=>d(e,{id:a}),children:JSON.stringify(t[e])}),columnRender=e=>(0,i.jsx)("div",{className:"flex h-full items-center justify-center font-mono",children:e}),c=Object.keys(null!==(t=null==r?void 0:r[0])&&void 0!==t?t:[]).map((e,t)=>({idx:t,key:e,name:e,resizable:!0,parent:void 0,level:0,width:120,minWidth:120,maxWidth:void 0,draggable:!1,frozen:!1,sortable:!1,isLastFrozenColumn:!1,renderCell:t=>{let{row:n}=t;return formatter(e,n)},renderHeaderCell:()=>columnRender(e)}));return r.length<=0?(0,i.jsx)("div",{className:"bg-table-header-light [[data-theme*=dark]_&]:bg-table-header-dark",children:(0,i.jsx)("p",{className:"m-0 border-0 px-6 py-4 font-mono text-sm",children:"Success. No rows returned"})}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(eR.ZP,{columns:c,rows:r,className:"flex-grow",rowClass:()=>"[&>.rdg-cell]:items-center",onSelectedCellChange:function(e){o(e)}}),(0,eA.createPortal)((0,i.jsx)(ek.v2,{id:a,animation:!1,children:(0,i.jsxs)(ek.ck,{onClick:onCopyCell,children:[(0,i.jsx)(em.Z,{size:"tiny"}),(0,i.jsx)("span",{className:"ml-2 text-xs",children:"Copy cell content"})]})}),document.body)]})},UtilityPanel_UtilityTabResults=e=>{var t,n,r,a,s,o,d,c,u,m,p,g,h;let{id:v,isExecuting:x}=e,{ui:b}=(0,R.oR)(),j=(0,R.lL)(),_=(0,P.W2)(),{mutateAsync:N,isLoading:E}=(0,eC.V)(),{setDebugSolution:w,setAiInput:A,setSqlDiff:q,sqlDiff:T}=function(){let e=(0,l.useContext)(eI);if(!e)throw Error("No SQL editor context. Are you using useSqlEditor() outside of SQLEditor?");return e}(),I=(0,R.lL)(),L=(0,R.Vm)(),D=null!==(c=null==I?void 0:null===(t=I.opt_in_tags)||void 0===t?void 0:t.includes(f.PV.AI_SQL))&&void 0!==c&&c,[U]=(0,R.ly)("supabase_sql-editor-ai-schema-enabled",!0),F=(D||!f.Qy)&&U,{data:z}=(0,S.u)({projectRef:null==L?void 0:L.ref,connectionString:null==L?void 0:L.connectionString},{enabled:F}),O=F?null==z?void 0:z.map(e=>e.sql.trim()):void 0,M=_.snippets[v],W=null===(n=_.results[v])||void 0===n?void 0:n[0],V=(null!==(u=null==M?void 0:null===(r=M.splitSizes)||void 0===r?void 0:r[1])&&void 0!==u?u:0)===0,{data:H}=(0,C.G)({orgSlug:null==j?void 0:j.slug}),K=(0,$.$)(H),G=(null==W?void 0:null===(s=W.error)||void 0===s?void 0:null===(a=s.message)||void 0===a?void 0:a.includes("canceling statement due to statement timeout"))||(null==W?void 0:null===(d=W.error)||void 0===d?void 0:null===(o=d.message)||void 0===o?void 0:o.includes("upstream request timeout"));if(V)return null;if(x)return(0,i.jsx)("div",{className:"bg-table-header-light [[data-theme*=dark]_&]:bg-table-header-dark",children:(0,i.jsx)("p",{className:"m-0 border-0 px-6 py-4 font-mono text-sm",children:"Running..."})});if(null==W?void 0:W.error){let e=(null!==(h=null===(p=W.error)||void 0===p?void 0:null===(m=p.formattedError)||void 0===m?void 0:m.split("\n"))&&void 0!==h?h:[]).filter(e=>e.length>0);return(0,i.jsx)("div",{className:"bg-table-header-light [[data-theme*=dark]_&]:bg-table-header-dark",children:(0,i.jsxs)("div",{className:"flex flex-row justify-between items-start py-4 px-6",children:[G?(0,i.jsxs)("div",{className:"flex flex-col gap-y-1",children:[(0,i.jsx)("p",{className:"font-mono text-sm",children:"SQL query ran into an upstream timeout"}),(0,i.jsxs)("p",{className:"font-mono text-sm text-foreground-light",children:["You can either"," ",(0,i.jsx)("a",{target:"_blank",rel:"noreferrer",className:"underline transition hover:text-foreground",href:"https://supabase.com/docs/guides/platform/performance#examining-query-performance",children:"optimize your query"}),", or"," ",(0,i.jsx)("a",{target:"_blank",rel:"noreferrer",className:"underline transition hover:text-foreground",href:"https://supabase.com/docs/guides/database/timeouts",children:"increase the statement timeout"}),"."]})]}):(0,i.jsx)("div",{children:e.length>0?e.map((e,t)=>(0,i.jsx)("pre",{className:"font-mono text-sm",children:e},"error-".concat(t))):(0,i.jsx)("p",{className:"font-mono text-sm",children:null===(g=W.error)||void 0===g?void 0:g.message})}),!K&&(0,i.jsx)(Z.z,{icon:(0,i.jsx)("div",{className:"scale-75",children:(0,i.jsx)(Q.c,{className:"w-3 h-3",loading:E})}),disabled:!!T||E,onClick:async()=>{try{let{solution:e,sql:t}=await N({sql:M.snippet.content.sql.replace(B.eg,"").trim(),errorMessage:W.error.message,entityDefinitions:O}),n=B.eg+"\n\n"+(0,y.WU)(t,{language:"postgresql",keywordCase:"lower"});A(""),w(e),q({original:M.snippet.content.sql,modified:n})}catch(e){(0,k.V)(e)&&b.setNotification({category:"error",message:"Failed to debug: ".concat(e.message)})}},children:"Debug with Supabase AI"})]})})}return W?(0,i.jsx)("div",{className:"h-full flex flex-col",children:(0,i.jsx)(UtilityPanel_Results,{id:v,rows:W.rows})}):(0,i.jsx)("div",{className:"bg-table-header-light [[data-theme*=dark]_&]:bg-table-header-dark",children:(0,i.jsxs)("p",{className:"m-0 border-0 px-6 py-4 text-sm text-foreground-light",children:["Click ",(0,i.jsx)("code",{children:"Run"})," to execute your query."]})})},UtilityPanel_UtilityPanel=e=>{let{id:t,isExecuting:n,isDisabled:r,hasSelection:a,prettifyQuery:s,executeQuery:l}=e;return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"flex justify-between overflow-visible px-6 py-2 border-b",children:[(0,i.jsx)(UtilityPanel_ResultsDropdown,{id:t,isExecuting:n}),(0,i.jsx)("div",{className:"inline-flex items-center justify-end",children:(0,i.jsx)(UtilityPanel_UtilityActions,{id:t,isExecuting:n,isDisabled:r,hasSelection:a,prettifyQuery:s,executeQuery:l})})]}),(0,i.jsx)("div",{className:"flex-1 p-0 pt-0 pb-0",children:(0,i.jsx)(UtilityPanel_UtilityTabResults,{id:t,isExecuting:n})})]})};let eq=x()(()=>n.e(1966).then(n.bind(n,81966)),{loadableGenerated:{webpack:()=>[81966]},ssr:!1}),eT=x()(()=>Promise.resolve().then(n.bind(n,79534)).then(e=>{let{DiffEditor:t}=e;return t}),{loadableGenerated:{webpack:()=>[79534]},ssr:!1}),eI=(0,l.createContext)(void 0);var SQLEditor_SQLEditor=()=>{var e,t,n;let{ui:a}=(0,R.oR)(),{ref:s,id:d}=(0,o.UO)(),c=(0,r.useRouter)(),u=(0,o.Mk)(),m=(0,l.useMemo)(()=>(0,A.k$)(),[d]),p=d&&"new"!==d?d:m,{profile:v}=(0,q.Un)(),x=(0,R.Vm)(),J=(0,R.lL)(),Y=(0,L.WZ)(),et=(0,P.W2)(),en=(0,D.TF)(),{mutate:ei}=useFormatQueryMutation(),{mutateAsync:er,isLoading:ea}=useSqlGenerateMutation(),{mutateAsync:es,isLoading:el}=useSqlEditMutation(),{mutateAsync:eo}=(0,N.g)(),{mutateAsync:ed}=(0,N.g)(),[ec,eu]=(0,l.useState)(""),[em,ep]=(0,l.useState)(),[ef,eg]=(0,l.useState)(),[eh,ev]=(0,l.useState)(),[ex,eb]=(0,l.useState)(!1),ey=(0,l.useRef)(null),ej=(0,R.P5)("readReplicas"),e_=ej&&(null==x?void 0:x.is_read_replicas_enabled),{data:eN}=(0,C.G)({orgSlug:null==J?void 0:J.slug}),{data:eS,isSuccess:eE}=(0,E.b)({projectRef:s}),ew=(0,$.$)(eN),[eC,ek]=(0,R.ly)("supabase_sql-editor-ai-open",!0),[eR,eA]=(0,l.useState)(!1),eL=(0,R.lL)(),eD=(0,R.Vm)(),eU=null!==(t=null==eL?void 0:null===(e=eL.opt_in_tags)||void 0===e?void 0:e.includes(f.PV.AI_SQL))&&void 0!==t&&t,[eP]=(0,R.ly)("supabase_sql-editor-ai-schema-enabled",!0),[eF,eQ]=(0,l.useState)(!1),[,ez]=(0,R.ly)("supabase_sql-editor-ai-query-count",0),[,eZ]=(0,R.ly)("supabase_sql-editor-ai-schema-suggestion-dismissed",!1),eO=(eU||!f.Qy)&&eP,[eM,eW]=(0,l.useState)(X.U.Modification),[eV,eH]=(0,l.useState)(!0),[eK,eG]=(0,l.useState)([]),e$=ea||el;(0,l.useEffect)(()=>{eH(!1)},[]),(0,l.useEffect)(()=>{if(eE){let e=eS.find(e=>e.identifier===s);en.setSelectedDatabaseId(null==e?void 0:e.identifier)}},[eE,eS,s]);let{data:eJ,refetch:eY}=(0,S.u)({projectRef:null==eD?void 0:eD.ref,connectionString:null==eD?void 0:eD.connectionString},{enabled:eO}),eB=eO?null==eJ?void 0:eJ.map(e=>e.sql.trim()):void 0,eX=!!ef,[e0,e1]=(0,R._)("supabase_sql-editor-split-size","[50, 50]"),e2=e0?JSON.parse(e0):void 0,{mutate:e3,isLoading:e4}=(0,w.r)({onSuccess(e){p&&et.addResult(p,e.result),eY()},onError(e){if(p){if(e.position&&e7.current){var t;let n=e9.current,i=e7.current,r=null!==(t=e.formattedError)&&void 0!==t?t:"",a=r.slice(r.indexOf("LINE")),s=Number(a.slice(0,a.indexOf(":")).split(" ")[1]);if(!isNaN(s)){let e=null==n?void 0:n.deltaDecorations([],[{range:new i.Range(s,1,s,20),options:{isWholeLine:!0,inlineClassName:"bg-amber-800"}}]);e&&(null==n||n.revealLineInCenter(s),eG(e))}}et.addResultError(p,e)}}}),e5=p?et.snippets[p]:null,e8="new"!==d&&!(p&&s&&et.loaded[s]),e6=(0,l.useCallback)(e=>{p&&et.setSplitSizes(p,e),e1(JSON.stringify(e))},[p]),e9=(0,l.useRef)(null),e7=(0,l.useRef)(null),te=(0,l.useRef)(null),tt=(0,l.useCallback)(async(e,t)=>{let{title:n}=await ed({sql:t});et.renameSnippet(e,n)},[ed,et]),tn=(0,l.useCallback)(async()=>{if(eX)return;let e=(0,P.X8)(),t=e.snippets[p];if(e9.current&&x){var n,i,r,a;let e=e9.current,s=e.getSelection(),l=s?null===(n=e.getModel())||void 0===n?void 0:n.getValueInRange(s):void 0,o=t?null!==(a=l||(null===(i=e9.current)||void 0===i?void 0:i.getValue()))&&void 0!==a?a:t.snippet.content.sql:l||(null===(r=e9.current)||void 0===r?void 0:r.getValue());ei({projectRef:x.ref,connectionString:x.connectionString,sql:o},{onSuccess:e=>{var t;let n=null==e9?void 0:null===(t=e9.current)||void 0===t?void 0:t.getModel();e9.current&&n&&(e9.current.executeEdits("apply-prettify-edit",[{text:e.result,range:n.getFullModelRange()}]),et.setSql(p,e.result))}})}},[ei,p,eX,x,et]),ti=(0,U.z6)(),tr=(0,l.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(eX)return;let t=(0,P.X8)(),n=t.snippets[p];if(null!==e9.current&&!e4&&void 0!==x){var i,r,a,s,l;let t=e9.current,o=t.getSelection(),d=o?null===(i=t.getModel())||void 0===i?void 0:i.getValueInRange(o):void 0,c=n?null!==(l=d||(null===(r=e9.current)||void 0===r?void 0:r.getValue()))&&void 0!==l?l:n.snippet.content.sql:d||(null===(a=e9.current)||void 0===a?void 0:a.getValue()),u=(0,ee.mw)(c);if(!e&&u){eA(!0);return}ew||(null==n?void 0:n.snippet.name)!==B.$C||tt(p,c),eK.length>0&&(null==t||t.deltaDecorations(eK,[]),eG([]));let m=ti(),g=e_?null==eS?void 0:null===(s=eS.find(e=>e.identifier===en.selectedDatabaseId))||void 0===s?void 0:s.connectionString:x.connectionString;if(f.Qy&&!g)return _.ZP.error("Unable to run query: Connection string is missing");e3({projectRef:x.ref,connectionString:g,sql:(0,T.Jh)(c,{projectRef:x.ref,role:m}),isRoleImpersonationEnabled:(0,U.Gm)(m)})}},[eX,p,e4,x,ew,e3,ti,tt,en.selectedDatabaseId,eS]),ta=(0,l.useCallback)(async(e,t)=>{if(!s)return console.error("Project ref is required");try{let n=(0,ee.UA)({id:(0,A.k$)(),name:t,sql:e,owner_id:null==v?void 0:v.id,project_id:null==x?void 0:x.id});et.addSnippet(n,s),et.addNeedsSaving(n.id),c.push("/project/".concat(s,"/sql/").concat(n.id))}catch(e){a.setNotification({category:"error",message:"Failed to create new query: ".concat(e.message)})}},[null==v?void 0:v.id,null==x?void 0:x.id,s,c,et,a]),ts=(0,l.useCallback)(async()=>{try{if(eQ(!0),!ef||!e9.current||!te.current)return;let e=e9.current.getModel(),t=te.current.getModel();if(!e||!t)return;let n=t.modified.getValue();if(eM===X.U.NewSnippet){let{title:e}=await eo({sql:n});await ta(n,e)}else e9.current.executeEdits("apply-ai-edit",[{text:n,range:e.getFullModelRange()}]),eh&&et.renameSnippet(p,eh);I.Z.sendEvent({category:"sql_editor",action:"ai_suggestion_accepted",label:em?"debug_snippet":"edit_snippet"},u,c),eu(""),eW(X.U.Modification),ep(void 0),eg(void 0),ev(void 0)}finally{eQ(!1)}},[ef,eM,ta,eo,em,u,c,p,eh,et]),tl=(0,l.useCallback)(()=>{I.Z.sendEvent({category:"sql_editor",action:"ai_suggestion_rejected",label:em?"debug_snippet":"edit_snippet"},u,c),ep(void 0),eg(void 0),ev(void 0)},[em,u,c]);(0,l.useEffect)(()=>{let handler=e=>{if(eX)switch(e.key){case"Enter":ts();return;case"Escape":tl();return}};return window.addEventListener("keydown",handler),()=>window.removeEventListener("keydown",handler)},[eX,ts,tl]);let to=(0,l.useCallback)(()=>{var e;let t=null===(e=te.current)||void 0===e?void 0:e.getModel();if(!t)throw Error("Diff editor's model not available");if(!ef)throw Error("Returned SQL diff not available");t.original.setValue(ef.original),t.modified.setValue(ef.modified)},[ef]),td=(0,l.useCallback)(()=>{var e;let t=null===(e=te.current)||void 0===e?void 0:e.getModel();if(!t)throw Error("Diff editor's model not available");if(!ef)throw Error("Returned SQL diff not available");let n=ef.original.replace(B.eg,"").trim(),i=ef.modified.replace(B.eg,"").trim(),r=B.eg+"\n\n"+(n?n+"\n\n":"")+i;t.original.setValue(ef.original),t.modified.setValue(r)},[ef]),tc=(0,l.useCallback)(()=>{var e;let t=null===(e=te.current)||void 0===e?void 0:e.getModel();if(!t)throw Error("Diff editor's model not available");if(!ef)throw Error("Returned SQL diff not available");t.original.setValue(""),t.modified.setValue(ef.modified)},[ef]);return(0,i.jsxs)(eI.Provider,{value:{aiInput:ec,setAiInput:eu,sqlDiff:ef,setSqlDiff:eg,debugSolution:em,setDebugSolution:ep},children:[(0,i.jsx)(j.Z,{visible:eR,title:"Destructive operation",danger:!0,description:"We've detected a potentially destructive operation in the query. Please confirm that you would like to execute this query.",buttonLabel:"Run destructive query",onSelectCancel:()=>{eA(!1)},onSelectConfirm:()=>{eA(!1),tr(!0)}}),(0,i.jsxs)("div",{className:"flex h-full flex-col relative",children:[eC&&!ew&&(0,i.jsx)(SQLEditor_AISchemaSuggestionPopover,{onClickSettings:()=>{Y.setShowAiSettingsModal(!0)},children:(0,i.jsx)(g.E.div,{layoutId:"ask-ai-input-container",variants:{visible:{borderRadius:0,x:0},hidden:{x:100}},initial:eV?"visible":"hidden",animate:"visible",className:"w-full flex justify-center z-10 h-[60px] bg-brand-300 border-b border-brand-400 px-5",children:(0,i.jsxs)("div",{className:(0,F.cn)("w-full !border-brand-900 border-none !shadow-none","flex items-center gap-3"),children:[(0,i.jsx)(g.E.div,{layoutId:"ask-ai-input-icon",transition:{duration:.1},children:(0,i.jsx)(Q.c,{loading:e$})}),(0,i.jsxs)(h.M,{initial:!1,exitBeforeEnter:!0,children:[em&&(0,i.jsx)("div",{className:"h-full w-full flex flex-row items-center overflow-y-hidden text-sm text-white",children:em}),!e$&&!em&&(0,i.jsx)(g.E.div,{className:"w-full h-full relative flex items-center",variants:{visible:{opacity:1,y:0},hidden:{opacity:0,y:-25}},initial:"hidden",animate:"visible",exit:"hidden",transition:{duration:.1},children:(0,i.jsx)(z.I,{value:ec,onChange:e=>eu(e.currentTarget.value),disabled:eX,ref:ey,className:(0,F.cn)("!p-0 bg-transparent border-transparent text-sm text-brand-600 placeholder:text-brand-500 focus:!ring-0","focus-visible:ring-0 focus-visible:ring-offset-0","appearance-none outline-none"),placeholder:em?"":(null==e5?void 0:e5.snippet.content.sql.trim())?"Ask Supabase AI to modify your query":"Ask Supabase AI to build a query",onKeyDown:e=>{"Escape"!==e.key||ec||ek(!1)},onKeyPress:async e=>{if("Enter"===e.key)try{var t;let n,i;let r=e.currentTarget.value;if(!r)return;let s=null===(t=e9.current)||void 0===t?void 0:t.getValue();s?{sql:n}=await es({prompt:r,sql:s.replace(B.eg,"").trim(),entityDefinitions:eB}):{sql:n,title:i}=await er({prompt:r,entityDefinitions:eB}),ez(e=>e+1);let l=B.eg+"\n\n"+(0,y.WU)(n,{language:"postgresql",keywordCase:"lower"});if(s&&l.trim()===s.trim()){a.setNotification({category:"error",message:"Unable to edit SQL. Try adding more details to your prompt."});return}eg({original:null!=s?s:"",modified:l}),i&&ev(i)}catch(e){(0,k.V)(e)&&a.setNotification({category:"error",message:e.message})}}})},"ask-ai-input"),e$&&(0,i.jsx)(g.E.div,{className:"p-0 flex flex-row gap-2 items-center w-full",variants:{visible:{opacity:1,y:0},hidden:{opacity:0,y:25}},transition:{duration:.2},initial:"hidden",animate:"visible",exit:"hidden",children:(0,i.jsx)(g.E.span,{className:"text-sm text-brand px-3",animate:{opacity:["0.5","0.75","0.5"],transition:{ease:"linear",duration:.33,repeat:1/0}},children:"Thinking..."})},"ask-ai-loading")]}),(0,i.jsx)("div",{className:"flex flex-row items-center gap-3 mr-1",children:eX?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"flex items-center",children:[(0,i.jsx)(Z.z,{className:"rounded-r-none",type:"primary",size:"tiny",icon:eF?(0,i.jsx)(M.Z,{className:"animate-spin",size:14}):(0,i.jsx)(O.Z,{}),iconRight:(0,i.jsx)("div",{className:"opacity-30",children:(0,i.jsx)(W.Z,{size:12,strokeWidth:1.5})}),onClick:ts,children:(0,ee.re)(eM)}),(0,i.jsxs)(V.h_,{children:[(0,i.jsx)(V.$F,{asChild:!0,children:(0,i.jsx)(Z.z,{type:"primary",className:"rounded-l-none border-l-0 px-[4px] py-[5px] flex",icon:(0,i.jsx)(H.Z,{})})}),(0,i.jsx)(V.AW,{align:"end",side:"bottom",children:Object.values(X.U).filter(e=>e!==eM).map(e=>(0,i.jsx)(V.Xi,{onClick:()=>{switch(eW(e),e){case X.U.Modification:return to();case X.U.Addition:return td();case X.U.NewSnippet:return tc();default:throw Error("Unknown diff type '".concat(e,"'"))}},children:(0,i.jsx)("p",{children:(0,ee.IT)(e)})},e))})]})]}),(0,i.jsx)(Z.z,{type:"alternative",size:"tiny",icon:(0,i.jsx)(K.Z,{}),iconRight:(0,i.jsx)("span",{className:"opacity-30",children:"ESC"}),onClick:tl,children:"Discard"})]}):(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("div",{className:(0,F.cn)("transition text-brand",ec?"opacity-30":"opacity-0"),children:(0,i.jsx)(W.Z,{size:16,strokeWidth:1.5})}),(0,i.jsx)("button",{onClick:()=>{eZ(!0),Y.setShowAiSettingsModal(!0)},className:"text-brand-600 hover:text-brand-600 transition",children:(0,i.jsx)(G.Z,{className:"cursor-pointer"})}),(0,i.jsx)("button",{className:"text-brand-600 hover:text-brand-600",onClick:()=>ek(!1),children:(0,i.jsx)(K.Z,{size:21})})]})})]})},"ask-ai-input-container")}),(0,i.jsxs)(b.Z,{style:{height:"100%"},direction:"vertical",gutterSize:2,sizes:null!==(n=e2||(null==e5?void 0:e5.splitSizes))&&void 0!==n?n:[50,50],minSize:44,snapOffset:50,expandToMin:!0,onDragEnd:e6,children:[(0,i.jsxs)("div",{className:"flex-grow overflow-y-auto border-b",children:[!eC&&(0,i.jsx)(g.E.button,{layoutId:"ask-ai-input-icon",transition:{duration:.1},onClick:()=>ek(!eC),className:(0,F.cn)("group","absolute z-10","rounded-lg","right-[24px] top-4","transition-all duration-200","ease-out"),children:(0,i.jsx)(Q.c,{loading:!1,allowHoverEffect:!0})}),e8?(0,i.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:"Loading..."}):(0,i.jsxs)(i.Fragment,{children:[eX&&(0,i.jsx)(g.E.div,{className:"w-full h-full",variants:{visible:{opacity:1,filter:"blur(0px)"},hidden:{opacity:0,filter:"blur(10px)"}},initial:"hidden",animate:"visible",children:(0,i.jsx)(eT,{theme:"supabase",language:"pgsql",original:ef.original,modified:ef.modified,onMount:e=>{te.current=e;let t=!0;e.onDidUpdateDiff(()=>{if(!t)return;let n=e.getModel(),i=e.getLineChanges();if(!n||!i||0===i.length)return;let r=n.original.getValue(),a=(0,y.WU)(r.replace(B.eg,"").trim(),{language:"postgresql",keywordCase:"lower"}),s=n.modified.getValue(),l=r.includes(B.eg)?(B.eg+"\n\n").split("\n").length:0,o=n.original.getLineCount(),d=o-l,c=i.some(e=>e.originalEndLineNumber-e.originalStartLineNumber>.5*d)&&!s.includes(a);c&&(eW(X.U.Addition),td()),t=!1})},options:{fontSize:13}})}),(0,i.jsx)(g.E.div,{variants:{visible:{opacity:1,filter:"blur(0px)"},hidden:{opacity:0,filter:"blur(10px)"}},initial:"hidden",animate:eX?"hidden":"visible",className:"w-full h-full",children:(0,i.jsx)(eq,{autoFocus:!0,id:p,editorRef:e9,monacoRef:e7,executeQuery:tr,onHasSelection:eb})},p)]})]}),(0,i.jsx)("div",{className:"flex flex-col",children:e8?(0,i.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:"Loading..."}):(0,i.jsx)(UtilityPanel_UtilityPanel,{id:p,isExecuting:e4,isDisabled:eX,hasSelection:ex,prettifyQuery:tn,executeQuery:tr})})]})]})]})},eL=n(51373),eD=n(35322);function fixQuotedIdent(e){return e.replace(/^\"/,"").replace(/\"$/,"").replace(/\"\"/,'"')}function formatInsertText(e){let t=e!=e.toLowerCase();return t?'"'.concat(e,'"'):e}let SqlEditor=()=>{let e=(0,r.useRouter)(),t=(0,a.useMonaco)(),{id:n,ref:s}=(0,o.UO)(),{project:d}=(0,et.d2)(),m=(0,P.W2)(),p=(0,L.WZ)(),f=(0,P.Fy)(s),{mutateAsync:g}=useFormatQueryMutation();async function formatPgsql(e){try{if(!d)throw Error("No project");let t=await g({projectRef:d.ref,connectionString:d.connectionString,sql:e});return t.result}catch(t){return console.error("formatPgsql error:",t),e}}let{data:h,isSuccess:v}=useKeywordsQuery({projectRef:null==d?void 0:d.ref,connectionString:null==d?void 0:d.connectionString}),{data:x,isSuccess:b}=useFunctionsQuery({projectRef:null==d?void 0:d.ref,connectionString:null==d?void 0:d.connectionString}),{data:y,isSuccess:j}=(0,c.Q1)({projectRef:null==d?void 0:d.ref,connectionString:null==d?void 0:d.connectionString}),{data:_,isSuccess:N}=(0,u.K)({projectRef:null==d?void 0:d.ref,connectionString:null==d?void 0:d.connectionString}),S=(0,l.useRef)(null),E=(0,l.useRef)(formatPgsql);E.current=formatPgsql;let w=N&&j&&v&&b;return w&&(null===S.current&&(S.current={}),S.current.tableColumns=null==_?void 0:_.result,S.current.schemas=y,S.current.keywords=null==h?void 0:h.result,S.current.functions=null==x?void 0:x.result),(0,l.useEffect)(()=>{if("new"===n&&void 0!==p.dashboardHistory.sql){let t=f.find(e=>e.id===p.dashboardHistory.sql);void 0!==t&&e.push("/project/".concat(s,"/sql/").concat(p.dashboardHistory.sql))}},[n,f]),(0,l.useEffect)(()=>{if(t){let e=t.languages.registerDocumentFormattingEditProvider("pgsql",{async provideDocumentFormattingEdits(e){let t=e.getValue(),i=await E.current(t);return n&&m.setSql(n,i),[{range:e.getFullModelRange(),text:i}]}});return()=>e.dispose()}},[t]),(0,l.useEffect)(()=>{if(w){let e,n;return t&&w&&(e=t.languages.registerCompletionItemProvider("pgsql",{triggerCharacters:[" ",".",'"'],provideCompletionItems:function(e,n,i){try{let r=new eD.Z(e,n.column-2,n.lineNumber-1);if('"'===i.triggerCharacter)return function(e,t,n){let i=[];if(!n.isFowardDQuote())return{suggestions:i};if(n.next(),n.isNextPeriod()){let r=n.readIdent(),a=!1;r.match(/^\".*?\"$/)&&(a=!0,r=fixQuotedIdent(r));let s=t.current.tableColumns.find(e=>a&&e.tablename===r||!a&&e.tablename.toLocaleLowerCase()==r.toLocaleLowerCase());if(!s)return{suggestions:i};s.columns.forEach(t=>{i.push({label:t.attname,kind:e.languages.CompletionItemKind.Property,detail:t.data_type,insertText:t.attname})})}else t.current.tableColumns.forEach(t=>{i.push({label:t.tablename,kind:e.languages.CompletionItemKind.Class,insertText:t.tablename})});return{suggestions:i}}(t,S,r);if("."===i.triggerCharacter)return function(e,t,n){let i=[],r=n.readIdents(3).map(e=>{let t=!1;return e.match(/^\".*?\"$/)&&(t=!0,e=fixQuotedIdent(e)),{isQuoted:t,name:e}}),a=0,s=t.current.schemas.find(e=>{var t,n;let i=r&&r.length>a?r[a]:{};return i.isQuoted&&e.name===i.name||!i.isQuoted&&(null===(t=e.name)||void 0===t?void 0:t.toLocaleLowerCase())==(null===(n=i.name)||void 0===n?void 0:n.toLocaleLowerCase())});if(s?a++:s=t.current.schemas.find(e=>"public"==e.name),r.length==a)return t.current.tableColumns.forEach(t=>{t.schemaname==s.name&&i.push({label:t.tablename,kind:e.languages.CompletionItemKind.Class,detail:"public"!==t.schemaname?t.schemaname:null,insertText:formatInsertText(t.tablename)})}),{suggestions:i};let l=t.current.tableColumns.find(e=>{var t,n;let i=r&&r.length>a?r[a]:{};return e.schemaname==s.name&&i.isQuoted&&e.tablename===i.name||!i.isQuoted&&(null===(t=e.tablename)||void 0===t?void 0:t.toLocaleLowerCase())==(null===(n=i.name)||void 0===n?void 0:n.toLocaleLowerCase())});return l&&l.columns.forEach(t=>{i.push({label:t.attname,kind:e.languages.CompletionItemKind.Property,detail:t.data_type,insertText:formatInsertText(t.attname)})}),{suggestions:i}}(t,S,r);return function(e,t){var n,i,r,a;let s=[];return(null===(n=t.current.keywords)||void 0===n?void 0:n.length)>0&&t.current.keywords.forEach(t=>{s.push({label:t,kind:e.languages.CompletionItemKind.Keyword,insertText:t})}),(null===(i=t.current.schemas)||void 0===i?void 0:i.length)>0&&t.current.schemas.forEach(t=>{s.push({label:t.name,kind:e.languages.CompletionItemKind.Keyword,insertText:t.name})}),(null===(r=t.current.tableColumns)||void 0===r?void 0:r.length)>0&&t.current.tableColumns.forEach(t=>{let n="public"==t.schemaname?t.tablename:t.schemaname+"."+t.tablename;s.push({label:t.tablename,detail:"public"!==t.schemaname?t.schemaname:null,kind:t.is_table?e.languages.CompletionItemKind.Class:e.languages.CompletionItemKind.Interface,insertText:formatInsertText(n)}),t.columns.forEach(n=>{if(!n)return;let i=s.find(t=>t.label===(null==n?void 0:n.attname)&&t.kind===e.languages.CompletionItemKind.Field&&t.detail===(null==n?void 0:n.data_type));i?(i.tables.push(t.tablename),i.tables.sort(),i.documentation=i.tables.join(", ")):s.push({label:n.attname,kind:e.languages.CompletionItemKind.Field,detail:n.data_type,documentation:t.tablename,tables:[t.tablename],insertText:formatInsertText(n.attname)})})}),(null===(a=t.current.functions)||void 0===a?void 0:a.length)>0&&t.current.functions.forEach(t=>{s.push({label:t.name,kind:e.languages.CompletionItemKind.Function,detail:t.result_type,documentation:t.description,insertText:t.name})}),{suggestions:s}}(t,S)}catch(e){return{suggestions:[]}}}}),n=t.languages.registerSignatureHelpProvider("pgsql",{signatureHelpTriggerCharacters:["(",","],provideSignatureHelp:function(e,t){let n=new eD.Z(e,t.column-2,t.lineNumber-1),i=n.readArguments();if(i<0)return null;let r=n.readIdent();if(!r||r.match(/^\".*?\"$/))return null;let a=S.current.functions.find(e=>e.name.toLocaleLowerCase()===r.toLocaleLowerCase());if(!a||!a.args||a.args.length<i)return null;let s=Math.min(i,a.args.length-1),l=[];return l.push({label:"".concat(a.name,"( ").concat(a.args.join(" , ")," )"),documentation:a.description,parameters:a.args.map(e=>({label:e}))}),{value:{signatures:l,activeSignature:0,activeParameter:s},dispose:()=>{}}}})),()=>{null==e||e.dispose(),null==n||n.dispose()}}},[w]),(0,i.jsx)("div",{className:"SQLTabContainer flex-1",children:(0,i.jsx)(SQLEditor_SQLEditor,{})})};SqlEditor.getLayout=e=>(0,i.jsx)(eL.Vk,{title:"SQL",children:e});var eU=(0,s.Pi)(SqlEditor)},83359:function(e,t,n){"use strict";var i=n(52322);n(2784);var r=n(50468),a=n(97265);t.Z=function(e){return(0,i.jsx)(a.Z,{icon:r.Z,...e})}},1863:function(e,t,n){"use strict";var i=n(52322);n(2784);var r=n(52145),a=n(97265);t.Z=function(e){return(0,i.jsx)(a.Z,{icon:r.Z,...e})}},26483:function(e,t,n){"use strict";var i=n(52322);n(2784);var r=n(72600),a=n(97265);t.Z=function(e){return(0,i.jsx)(a.Z,{icon:r.Z,...e})}}},function(e){e.O(0,[1715,1187,6653,3844,8421,9362,4796,806,2591,1971,3614,6782,2841,9281,1915,4079,4964,8211,452,8108,2894,9774,2888,179],function(){return e(e.s=98528)}),_N_E=e.O()}]);