(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5885],{50193:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/project/[ref]/auth/policies",function(){return s(58319)}])},15873:function(e,t,s){"use strict";s.d(t,{V:function(){return useSqlDebugMutation}});var n=s(62350),l=s(62202),a=s(3218),i=s(46732);async function debugSql(e){let{errorMessage:t,sql:s,entityDefinitions:n}=e,l=await (0,a.v_)(i.GW+"/api/ai/sql/debug",{errorMessage:t,sql:s,entityDefinitions:n});if(!(0,a.d8)(l))throw l.error;return l}let useSqlDebugMutation=function(){let{onSuccess:e,onError:t,...s}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,n.D)(e=>debugSql(e),{async onSuccess(t,s,n){await (null==e?void 0:e(t,s,n))},async onError(e,s,n){void 0===t?l.ZP.error("Failed to debug SQL: ".concat(e.message)):t(e,s,n)},...s})}},38488:function(e,t,s){"use strict";s.d(t,{r:function(){return useExecuteSqlMutation}});var n=s(62202),l=s(62350),a=s(70481);let useExecuteSqlMutation=function(){let{onSuccess:e,onError:t,...s}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,l.D)(e=>(0,a.Rj)(e),{async onSuccess(t,s,n){await (null==e?void 0:e(t,s,n))},async onError(e,s,l){void 0===t?n.Am.error("Failed to execute SQL: ".concat(e.message)):t(e,s,l)},...s})}},58319:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return eX}});var n=s(52322),l=s(24990),a=s(59491),i=s(96795),o=s.n(i),r=s(2784),c=s(60674),d=s(55691),u=s(77262),x=s(55830),m=s(27533),h=s(84636),p=s.n(h),f=s(81689),g=s(25237),v=s.n(g),j=s(62202),b=s(70241),N=s(10929),y=s(4220);let w=b.fC;b.xz;let S=b.x8,C=(0,N.j)("fixed inset-0 z-40 flex",{variants:{position:{top:"items-start",bottom:"items-end",left:"justify-start",right:"justify-end"}},defaultVariants:{position:"right"}}),SheetPortal=e=>{let{position:t,children:s,...l}=e;return(0,n.jsx)(b.h_,{...l,children:(0,n.jsx)("div",{className:C({position:t}),children:s})})};SheetPortal.displayName=b.h_.displayName;let E=r.forwardRef((e,t)=>{let{className:s,children:l,...a}=e;return(0,n.jsx)(b.aV,{className:(0,y.cn)("fixed inset-0 z-40 bg-background/80 backdrop-blur-sm transition-all duration-100 data-[state=closed]:animate-out data-[state=closed]:fade-out data-[state=open]:fade-in",s),...a,ref:t})});E.displayName=b.aV.displayName;let k=(0,N.j)("fixed z-40 scale-100 gap-4 bg-background p-6 opacity-100 shadow-lg border",{variants:{position:{top:"animate-in slide-in-from-top w-full duration-300",bottom:"animate-in slide-in-from-bottom w-full duration-300",left:"animate-in slide-in-from-left h-full duration-300",right:"animate-in slide-in-from-right h-full duration-300"},size:{content:"",default:"",sm:"",lg:"",xl:"",xxl:"",full:""}},compoundVariants:[{position:["top","bottom"],size:"content",class:"max-h-screen"},{position:["top","bottom"],size:"default",class:"h-1/3"},{position:["top","bottom"],size:"sm",class:"h-1/4"},{position:["top","bottom"],size:"lg",class:"h-1/2"},{position:["top","bottom"],size:"xl",class:"h-5/6"},{position:["top","bottom"],size:"full",class:"h-screen"},{position:["right","left"],size:"content",class:"max-w-screen"},{position:["right","left"],size:"default",class:"w-1/3"},{position:["right","left"],size:"sm",class:"w-1/4"},{position:["right","left"],size:"lg",class:"w-1/2"},{position:["right","left"],size:"xl",class:"w-4/6"},{position:["right","left"],size:"xxl",class:"w-5/6"},{position:["right","left"],size:"full",class:"w-screen"}],defaultVariants:{position:"right",size:"default"}}),A=r.forwardRef((e,t)=>{let{position:s,size:l,className:a,children:i,...o}=e;return(0,n.jsxs)(SheetPortal,{position:s,children:[(0,n.jsx)(E,{}),(0,n.jsx)(b.VY,{ref:t,className:(0,y.cn)(k({position:s,size:l}),a),...o,children:i})]})});A.displayName=b.VY.displayName;let SheetHeader=e=>{let{className:t,...s}=e;return(0,n.jsx)("div",{className:(0,y.cn)("px-5 py-4 text-center sm:text-left",t),...s})};SheetHeader.displayName="SheetHeader";let SheetFooter=e=>{let{className:t,...s}=e;return(0,n.jsx)("div",{className:(0,y.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s})};SheetFooter.displayName="SheetFooter";let _=r.forwardRef((e,t)=>{let{className:s,...l}=e;return(0,n.jsx)(b.Dx,{ref:t,className:(0,y.cn)("text-base text-foreground",s),...l})});_.displayName=b.Dx.displayName;let P=r.forwardRef((e,t)=>{let{className:s,...l}=e;return(0,n.jsx)(b.dk,{ref:t,className:(0,y.cn)("text-sm text-foreground-muted",s),...l})});P.displayName=b.dk.displayName;var z=s(94580),I=s(1681),R=s(98050),T=s(15873),D=s(35629),L=s(78961),V=s(38488),M=s(89465),O=s(46732),Z=s(71813),F=s(88883),H=s(60417),q=s.n(H),W=s(56974),U=s.n(W),Y=s(47716),G=s(63955),Q=s(71164),B=s(69218),K=s(70971),$=s(84283),X=s(30195),J=s(96689),ee=s(5632),et=s(84447),es=s(64439),en=s(28879),el=s.n(en),ea=s(34291),ei=s.n(ea),eo=s(96577),er=s.n(eo),ec=s(29071),ed=s(89735),eu=s(9839),ex=s(84959),em=s(8882),eh=s(83030),ep=s(55050),ef=s(36782),eg=s(8897);let AIPolicyPre=e=>{let{onDiff:t,children:s,className:a}=e,[i,o]=(0,r.useState)(!1),d=(0,ee.useRouter)(),u=(0,c.Mk)();(0,r.useEffect)(()=>{if(!i)return;let e=setTimeout(()=>o(!1),2e3);return()=>clearTimeout(e)},[i]);let x=(s||[""])[0];try{x=(0,ef.WU)(x,{language:"postgresql",keywordCase:"upper"})}catch(e){}return 0===x.length?null:(0,n.jsxs)("pre",{className:(0,y.cn)("rounded-md relative group",a),children:[(0,n.jsx)(eg.d,{value:x,language:"sql",className:(0,y.cn)("!bg-transparent !py-3 !px-3.5 prose dark:prose-dark","[&>code]:m-0 [&>code>span]:flex [&>code>span]:flex-wrap"),hideCopy:!0,hideLineNumbers:!0}),(0,n.jsxs)("div",{className:"absolute top-3 right-3 bg-surface-100 border-muted border rounded-lg h-[28px] hidden group-hover:block",children:[(0,n.jsxs)(l.fC,{delayDuration:0,children:[(0,n.jsx)(l.xz,{asChild:!0,children:(0,n.jsx)(z.z,{type:"text",size:"tiny",onClick:()=>{t(x),J.Z.sendEvent({category:"rls_editor",action:"ai_suggestion_diffed",label:"rls-ai-assistant"},u,d)},children:(0,n.jsx)(f.Z,{className:"h-4 w-4"})})}),(0,n.jsx)(l.h_,{children:(0,n.jsxs)(l.VY,{side:"bottom",children:[(0,n.jsx)(l.Eh,{className:"radix-tooltip-arrow"}),(0,n.jsx)("div",{className:"rounded bg-alternative py-1 px-2 leading-none shadow border border-background",children:(0,n.jsx)("span",{className:"text-xs text-foreground",children:"Apply changes"})})]})})]}),(0,n.jsxs)(l.fC,{delayDuration:0,children:[(0,n.jsx)(l.xz,{asChild:!0,children:(0,n.jsx)(z.z,{type:"text",size:"tiny",onClick:()=>{var e;e=x,navigator.clipboard.writeText(e).then(),o(!0),J.Z.sendEvent({category:"rls_editor",action:"ai_suggestion_copied",label:"rls-ai-assistant"},u,d)},children:i?(0,n.jsx)(eh.Z,{size:16,className:"text-brand-600"}):(0,n.jsx)(ep.Z,{size:16})})}),(0,n.jsx)(l.h_,{children:(0,n.jsxs)(l.VY,{side:"bottom",children:[(0,n.jsx)(l.Eh,{className:"radix-tooltip-arrow"}),(0,n.jsx)("div",{className:"rounded bg-alternative py-1 px-2 leading-none shadow border border-background",children:(0,n.jsx)("span",{className:"text-xs text-foreground",children:"Copy code"})})]})})]})]})]})},ev=(0,r.memo)(function(e){let{name:t,role:s,content:l,createdAt:a,isDebug:i,onDiff:o=ei(),children:c}=e,{profile:d}=(0,et.Un)(),u=(0,r.useMemo)(()=>"assistant"===s?(0,n.jsx)(eu.c,{loading:"Thinking..."===l,className:"[&>div>div]:border-black dark:[&>div>div]:border-white"}):(0,n.jsx)("div",{className:"relative border shadow-lg w-8 h-8 rounded-full overflow-hidden",children:(0,n.jsx)(er(),{src:"https://github.com/".concat(null==d?void 0:d.username,".png")||0,width:30,height:30,alt:"avatar",className:"relative"})}),[l,null==d?void 0:d.username,s]);return l?(0,n.jsxs)("div",{className:"flex flex-col py-4 gap-4 border-t px-5 text-foreground-light text-sm",children:[(0,n.jsxs)("div",{className:"flex flex-row gap-3 items-center",children:[u,(0,n.jsx)("span",{className:"text-sm",children:"assistant"===s?"Assistant":t||"You"}),a&&(0,n.jsx)("span",{className:"text-xs text-foreground-muted",children:el()(a).fromNow()}),i&&(0,n.jsx)(ex.Z,{color:"amber",children:"Debug request"})]}),(0,n.jsx)(ec.D,{className:"gap-2.5 flex flex-col",remarkPlugins:[ed.Z],components:{...em.t,pre:e=>(0,n.jsx)(AIPolicyPre,{onDiff:o,className:"pt-3",children:e.children[0].props.children})},children:l}),c]}):null}),AIPolicyChat=e=>{var t;let{messages:s,loading:l,onSubmit:a,onDiff:i,onChange:o}=e,{profile:d}=(0,et.Un)(),u=(0,es.WZ)(),x=(0,r.useRef)(null),m=(0,ee.useRouter)(),h=(0,c.Mk)(),p=q()([null==d?void 0:d.first_name,null==d?void 0:d.last_name]).join(" "),f=X.Ry({chat:X.Z_()}),g=(0,G.cI)({mode:"onBlur",reValidateMode:"onBlur",resolver:(0,F.F)(f),defaultValues:{chat:""}}),v=g.getValues().chat,j=l&&(null===(t=U()(s))||void 0===t?void 0:t.role)==="user";return(0,r.useEffect)(()=>{l&&x.current&&setTimeout(()=>{var e;null===(e=x.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},500)}),(0,r.useEffect)(()=>{l||(g.setValue("chat",""),g.setFocus("chat"))},[l]),(0,r.useEffect)(()=>{o(0===v.length)},[v]),(0,n.jsxs)("div",{id:"ai-chat-assistant",className:"flex flex-col h-full max-w-full",children:[(0,n.jsxs)("div",{className:"overflow-auto flex-1",children:[(0,n.jsx)(ev,{role:"assistant",content:"Hi".concat(p?" "+p:"",", how can I help you? I'm powered by AI, so surprises and mistakes are possible.\n        Make sure to verify any generated code or suggestions, and share feedback so that we can\n        learn and improve."),children:(0,n.jsx)("div",{children:(0,n.jsx)(z.z,{type:"default",icon:(0,n.jsx)(Q.Z,{strokeWidth:1.5}),onClick:()=>u.setShowAiSettingsModal(!0),children:"AI Settings"})})},"zero"),s.map(e=>(0,n.jsx)(ev,{name:e.name,role:e.role,content:e.content,createdAt:new Date(e.createdAt||new Date).getTime(),isDebug:e.isDebug,onDiff:i},"message-".concat(e.id))),j&&(0,n.jsx)(ev,{role:"assistant",content:"Thinking..."},"thinking"),(0,n.jsx)("div",{ref:x,className:"h-1"})]}),(0,n.jsx)(B.l0,{...g,children:(0,n.jsx)("form",{id:"rls-chat",className:"sticky p-5 flex-0 border-t",onSubmit:g.handleSubmit(e=>{a(e.chat),J.Z.sendEvent({category:"rls_editor",action:"ai_suggestion_asked",label:"rls-ai-assistant"},h,m)}),children:(0,n.jsx)(B.Wi,{control:g.control,name:"chat",render:e=>{let{field:t}=e;return(0,n.jsx)(B.xJ,{children:(0,n.jsx)(B.NI,{children:(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)(K.p,{className:"absolute top-2 left-3 [&>div>div]:border-black dark:[&>div>div]:border-white"}),(0,n.jsx)($.I,{...t,autoComplete:"off",disabled:l,autoFocus:!0,className:"bg-surface-300 dark:bg-black rounded-full pl-10 ".concat(l?"pr-10":""),placeholder:"Ask for some changes to your policy"}),l&&(0,n.jsx)(Y.Z,{className:"absolute top-2 right-3 animate-spin"})]})})})}})})})]})},generateThreadMessage=e=>{let{id:t,content:s,isDebug:n}=e,l={id:null!=t?t:(0,Z.k$)(),role:"assistant",content:s,createdAt:new Date,isDebug:n};return l},generatePlaceholder=e=>{if(void 0===e)return"\n-- Press tab to use this code\n\n&nbsp;\n\nCREATE POLICY *name* ON *table_name*\n\nAS PERMISSIVE -- PERMISSIVE | RESTRICTIVE\n\nFOR ALL -- ALL | SELECT | INSERT | UPDATE | DELETE\n\nTO *role_name* -- Default: public\n\nUSING ( *using_expression* )\n\nWITH CHECK ( *check_expression* );\n".trim();{let t="";return null!==e.definition&&void 0!==e.definition&&(t+="USING ( *".concat(e.definition,"* )").concat(null===e.check||void 0===e.check?";":"","\n")),null!==e.check&&void 0!==e.check&&(t+="WITH CHECK ( *".concat(e.check,"* );\n")),'\n-- Press tab to use this code\n\n&nbsp;\n\nBEGIN;\n\n&nbsp;\n\n-- To update your policy definition\n\nALTER POLICY "'.concat(e.name,'"\n\nON "').concat(e.schema,'"."').concat(e.table,'"\n\nTO *').concat(e.roles.join(", "),"*\n\n").concat(t,'\n&nbsp;\n\n-- To rename your policy\n\nALTER POLICY "').concat(e.name,'"\n\nON "').concat(e.schema,'"."').concat(e.table,'"\n\nRENAME TO "*New Policy Name*";\n\n&nbsp;\n\nCOMMIT;\n').trim()}},generatePolicyDefinition=e=>'\nCREATE POLICY "'.concat(e.name,'" on "').concat(e.schema,'"."').concat(e.table,'"\nAS ').concat(e.action," FOR ").concat(e.command,"\nTO ").concat(e.roles.join(", "),"\n").concat(e.definition?"USING (".concat(e.definition,")"):"","\n").concat(e.check?"WITH CHECK (".concat(e.check,")"):"","\n;\n").trim();var ej=s(44020),eb=s.n(ej),eN=s(6277),ey=s(88724),ew=s(8957),eS=s(21511);let AIPolicyHeader=e=>{let{selectedPolicy:t,assistantVisible:s,setAssistantVisible:l}=e,a=(0,M.lL)(),{data:i}=(0,eS.G)({orgSlug:null==a?void 0:a.slug}),o=(0,ew.$)(i);return(0,n.jsxs)(SheetHeader,{className:"".concat(void 0!==t?"pt-3 pb-0":"py-3"," flex flex-row justify-between items-center"),children:[(0,n.jsxs)("div",{className:"flex flex-row gap-3 items-center max-w-[75%]",children:[(0,n.jsxs)(S,{className:(0,eN.default)("text-light hover:text ring-offset-background transition-opacity hover:opacity-100","focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2","disabled:pointer-events-none data-[state=open]:bg-secondary"),children:[(0,n.jsx)(ey.Z,{className:"h-3 w-3"}),(0,n.jsx)("span",{className:"sr-only",children:"Close"})]}),(0,n.jsx)("div",{className:"h-[24px] w-[1px] bg-border"}),(0,n.jsx)(_,{className:"truncate",children:void 0!==t?"Update policy: ".concat(t.name):"Create a new Row Level Security policy"})]}),!o&&(0,n.jsx)(z.z,{"aria-expanded":s,"aria-controls":"ai-chat-assistant",size:"tiny",type:"outline",className:(0,y.cn)("group",eb()["ai-icon__container--allow-hover-effect"],"px-3 py-0.5"),rounded:!0,icon:(0,n.jsx)(K.p,{className:"scale-75 [&>div>div]:border-foreground-light [&>div>div]:group-hover:border-foreground -mr-0.5"}),onClick:()=>l(!s),children:s?(0,n.jsx)(n.Fragment,{children:"Close Assistant"}):(0,n.jsx)(n.Fragment,{children:"Open Assistant"})})]})};var eC=s(69557);let eE=eC.fC,ek=eC.wy,eA=eC.Fw;var e_=s(43502),AIPolicyEditorPanel_PolicyDetails=e=>{var t;let{policy:s,showDetails:l,toggleShowDetails:a}=e;return s?(0,n.jsxs)(eE,{className:"-mt-1.5 pb-1.5",open:l,onOpenChange:a,children:[(0,n.jsx)(ek,{className:"group pl-[3.6rem] font-normal p-0 [&[data-state=open]>div>svg]:!-rotate-180",children:(0,n.jsxs)("div",{className:"flex items-center gap-x-2 w-full",children:[(0,n.jsx)("p",{className:"text-xs text-foreground-light group-hover:text-foreground transition",children:"View policy details"}),(0,n.jsx)(e_.Z,{className:"transition-transform duration-200",strokeWidth:1.5,size:14})]})}),(0,n.jsx)(eA,{className:"pl-[3.6rem] my-2 grid gap-1.5",children:(0,n.jsx)("div",{className:"flex",children:(0,n.jsxs)("div",{children:[(0,n.jsxs)("div",{className:"text-xs flex items-start space-x-2 border-b py-1.5",children:[(0,n.jsx)("p",{className:"w-[110px] text-foreground-light",children:"Name:"}),(0,n.jsx)("p",{className:"pr-4",children:s.name})]}),(0,n.jsxs)("div",{className:"text-xs flex items-start space-x-2 border-b py-1.5",children:[(0,n.jsx)("p",{className:"w-[110px] text-foreground-light",children:"Action:"}),(0,n.jsx)("p",{className:"font-mono pr-4",children:s.action})]}),(0,n.jsxs)("div",{className:"text-xs flex items-start space-x-2 border-b py-1.5",children:[(0,n.jsx)("p",{className:"w-[110px] text-foreground-light",children:"Command:"}),(0,n.jsx)("p",{className:"font-mono pr-4",children:s.command})]}),(0,n.jsxs)("div",{className:"text-xs flex items-start space-x-2 border-b py-1.5",children:[(0,n.jsx)("p",{className:"w-[110px] text-foreground-light",children:"Target roles:"}),(0,n.jsx)("p",{className:"font-mono pr-4",children:s.roles.join(", ")})]}),(0,n.jsxs)("div",{className:"text-xs flex items-start space-x-2 border-b py-1.5",children:[(0,n.jsx)("p",{className:"w-[110px] text-foreground-light",children:"USING expression:"}),(0,n.jsx)("p",{className:"font-mono pr-4",children:s.definition})]}),(0,n.jsxs)("div",{className:"text-xs flex items-start space-x-2 pt-1.5",children:[(0,n.jsx)("p",{className:"w-[110px] text-foreground-light",children:"CHECK expression:"}),(0,n.jsx)("p",{className:"".concat(s.check?"":"text-foreground-light"," font-mono pr-4"),children:null!==(t=s.check)&&void 0!==t?t:"None"})]})]})})})]}):null},eP=s(87613),ez=s.n(eP),eI=s(50074),AIPolicyEditorPanel_QueryError=e=>{var t,s,l,a;let{error:i,open:o,setOpen:r,onSelectDebug:d}=e,u=null!==(a=null===(t=null!==(l=null==i?void 0:null===(s=i.formattedError)||void 0===s?void 0:s.split("\n"))&&void 0!==l?l:[])||void 0===t?void 0:t.filter(e=>e.length>0))&&void 0!==a?a:[],x=(0,M.lL)(),{data:m}=(0,eS.G)({orgSlug:null==x?void 0:x.slug}),h=(0,ew.$)(m),p=(0,ee.useRouter)(),f=(0,c.Mk)();return(0,n.jsxs)("div",{className:"flex flex-col gap-y-3 px-5",children:[(0,n.jsxs)(eI.bZ,{variant:"destructive",children:[(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",className:"w-5 h-5",children:(0,n.jsx)("path",{"fill-rule":"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-5a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0v-4.5A.75.75 0 0110 5zm0 10a1 1 0 100-2 1 1 0 000 2z","clip-rule":"evenodd"})}),(0,n.jsxs)("div",{className:"flex flex-col gap-3",children:[(0,n.jsx)(eI.Cd,{className:"m-0",children:"Error running SQL query"}),(0,n.jsxs)(eE,{defaultOpen:!0,className:"flex flex-col gap-3",open:o,onOpenChange:()=>r(!o),children:[(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(ek,{asChild:!0,children:(0,n.jsx)(z.z,{size:"tiny",type:"outline",className:(0,y.cn)("group",eb()["ai-icon__container--allow-hover-effect"]),children:o?"Hide error details":"Show error details"})}),!h&&(0,n.jsx)(z.z,{size:"tiny",type:"default",className:(0,y.cn)("group",eb()["ai-icon__container--allow-hover-effect h-[21px] !py-0"]),onClick:()=>{d(),J.Z.sendEvent({category:"rls_editor",action:"ai_debugger_requested",label:"rls-ai-assistant"},f,p)},children:"Fix with Assistant"})]}),(0,n.jsx)(eA,{className:"overflow-auto",children:u.length>0?u.map((e,t)=>(0,n.jsx)("pre",{className:"font-mono text-xs whitespace-pre-wrap",children:e.split(" ").reduce((e,t)=>{let s=U()(e);return s&&"ERROR:"!==s?ez()(e).concat([[s,t].join(" ")]):""===s?e.concat([" "]):e.concat([t])},[]).map((e,t,s)=>(0,n.jsx)("span",{className:(0,y.cn)("break-all","ERROR:"===e&&"text-destructive"),children:e},t))},"error-".concat(t))):(0,n.jsx)("p",{className:"font-mono text-xs",children:i.error})})]})]})]}),(0,n.jsx)("div",{className:"overflow-x-auto"})]})},eR=s(79534),eT=s(35229),eD=s(59323),AIPolicyEditorPanel_RLSCodeEditor=e=>{let{id:t,defaultValue:s,wrapperClassName:l,className:a,value:i,placeholder:o,editorRef:c}=e,d=(0,r.useRef)(),onMount=async(e,t)=>{c.current=e,(0,eT.$V)(e),d.current=e.createContextKey("hasValue",!1);let s=document.querySelector(".monaco-placeholder");s&&(s.style.display="block"),e.addCommand(t.KeyCode.Tab,()=>{e.executeEdits("source",[{identifier:"add-placeholder",range:new t.Range(1,1,1,1),text:(null!=o?o:"").split("\n\n").join("\n").replaceAll("*","").replaceAll("&nbsp;","")}])},"!hasValue"),e.focus()};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(eR.default,{path:t,theme:"supabase",wrapperProps:{className:(0,y.cn)(l)},className:(0,y.cn)(a,"monaco-editor"),value:null!=i?i:void 0,defaultLanguage:"pgsql",defaultValue:null!=s?s:void 0,options:{tabSize:2,fontSize:13,readOnly:!1,minimap:{enabled:!1},wordWrap:"on",fixedOverflowWidgets:!0,contextmenu:!0,lineNumbers:void 0,glyphMargin:void 0,lineNumbersMinChars:4,folding:void 0,scrollBeyondLastLine:!1},onMount:onMount,onChange:e=>{d.current.set((null!=e?e:"").length>0);let t=document.querySelector(".monaco-placeholder");t&&(e?t.style.display="none":t.style.display="block")}}),void 0!==o&&(0,n.jsx)("div",{className:"monaco-placeholder absolute top-[3px] left-[57px] text-sm pointer-events-none font-mono [&>div>p]:text-foreground-lighter [&>div>p]:!m-0 tracking-tighter",style:{display:"none"},children:(0,n.jsx)(eD.U,{content:o})})]})};let eL=v()(()=>Promise.resolve().then(s.bind(s,79534)).then(e=>{let{DiffEditor:t}=e;return t}),{loadableGenerated:{webpack:()=>[79534]},ssr:!1}),eV=(0,r.memo)(function(e){var t,s,l;let{visible:a,selectedPolicy:i,onSelectCancel:o}=e,{ref:d}=(0,c.UO)(),u=(0,x.NL)(),h=(0,M.Vm)(),g=(0,M.lL)(),v=(0,ee.useRouter)(),b=(0,c.Mk)(),[N,S]=(0,r.useState)((0,Z.k$)()),C=(0,r.useRef)(null),E=(0,r.useRef)(null),k=generatePlaceholder(i),_=null!==(l=null==g?void 0:null===(t=g.opt_in_tags)||void 0===t?void 0:t.includes(O.PV.AI_SQL))&&void 0!==l&&l,[P,F]=(0,r.useState)(),[H,q]=(0,r.useState)(!0),[W,U]=(0,r.useState)(!1),[Y,G]=(0,r.useState)([]),[Q,B]=(0,r.useState)(!1),[K,$]=(0,r.useState)(!0),[X,et]=(0,r.useState)(void 0),[es,en]=(0,r.useState)(!1),{data:el}=(0,L.u)({projectRef:null==h?void 0:h.ref,connectionString:null==h?void 0:h.connectionString},{enabled:!0,refetchOnWindowFocus:!1}),ea=null==el?void 0:el.map(e=>e.sql.trim()),{messages:ei,append:eo,isLoading:er}=(0,m.RJ)({id:N,api:"".concat(O.GW,"/api/ai/sql/suggest"),body:{entityDefinitions:_?ea:void 0,policyDefinition:void 0!==i?generatePolicyDefinition(i):void 0}}),ec=(0,r.useMemo)(()=>{let e=[...Y,...ei.map(e=>({...e,isDebug:!1}))];return e.sort((e,t)=>{var s,n,l,a;return(null!==(l=null===(s=e.createdAt)||void 0===s?void 0:s.getTime())&&void 0!==l?l:0)-(null!==(a=null===(n=t.createdAt)||void 0===n?void 0:n.getTime())&&void 0!==a?a:0)||e.role.localeCompare(t.role)})},[ei,Y]),{mutate:ed,isLoading:eu}=(0,V.r)({onSuccess:()=>{u.invalidateQueries(D.R.list(d)),j.ZP.success("Successfully created new policy"),o()},onError:e=>{F(e)}}),{mutateAsync:ex,isLoading:em}=(0,T.V)();null==P||P.formattedError.split("\n").filter(e=>e.length>0).length;let eh=(0,r.useCallback)(()=>{var e;let t=null===(e=C.current)||void 0===e?void 0:e.getValue().replaceAll("  "," ");t&&(F(void 0),ed({sql:t,projectRef:null==h?void 0:h.ref,connectionString:null==h?void 0:h.connectionString}))},[ed,null==h?void 0:h.connectionString,null==h?void 0:h.ref]),ep=(0,r.useCallback)(async()=>{if(!X||!C.current||!E.current)return;let e=C.current.getModel(),t=E.current.getModel();if(!e||!t)return;let s=t.modified.getValue();C.current.executeEdits("apply-ai-edit",[{text:s,range:e.getFullModelRange()}]),et(void 0)},[X]),ef=(0,r.useCallback)(()=>{var e;let t=null===(e=C.current)||void 0===e?void 0:e.getValue();t||ec.length>0||!K?en(!0):o()},[o,ec,K]),onSelectDebug=async()=>{var e;let t=null===(e=C.current)||void 0===e?void 0:e.getValue().replaceAll("\n"," ").replaceAll("  "," ");if(void 0===P||void 0===t)return;B(!0);let s=(0,Z.k$)(),n=generateThreadMessage({id:s,content:"Thinking...",isDebug:!0});G([...Y,n]);let{solution:l,sql:a}=await ex({sql:t.trim(),errorMessage:P.message,entityDefinitions:ea}),i=generateThreadMessage({id:s,content:"".concat(l,"\n```sql\n").concat(a,"\n```"),isDebug:!0}),o=p()([...Y,i],e=>e.id);G(o)};return(0,r.useEffect)(()=>{if(!a){var e;null===(e=C.current)||void 0===e||e.setValue(""),et(void 0),B(!1),en(!1),F(void 0),G([]),S((0,Z.k$)()),U(!1)}},[a]),(0,r.useEffect)(()=>{var e;null===(e=C.current)||void 0===e||e.layout({width:0,height:0}),window.requestAnimationFrame(()=>{var e;null===(e=C.current)||void 0===e||e.layout()})},[W,P,H]),(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(w,{open:a,onOpenChange:()=>ef(),children:(0,n.jsxs)(A,{size:Q?"lg":"default",className:(0,y.cn)("p-0 flex flex-row gap-0",Q?"!min-w-[1024px]":"!min-w-[600px]"),children:[(0,n.jsxs)("div",{className:(0,y.cn)("flex flex-col grow w-full",Q&&"w-[60%]"),children:[(0,n.jsx)(AIPolicyHeader,{selectedPolicy:i,assistantVisible:Q,setAssistantVisible:B}),(0,n.jsx)(AIPolicyEditorPanel_PolicyDetails,{policy:i,showDetails:W,toggleShowDetails:()=>U(!W)}),(0,n.jsxs)("div",{className:"flex flex-col h-full w-full justify-between",children:[X?(0,n.jsxs)("div",{className:"px-5 py-3 flex justify-between gap-3 bg-muted",children:[(0,n.jsxs)("div",{className:"flex gap-2 items-center text-foreground-light",children:[(0,n.jsx)(f.Z,{className:"h-4 w-4"}),(0,n.jsx)("span",{className:"text-sm",children:"Accept changes from assistant"})]}),(0,n.jsxs)("div",{className:"flex gap-3",children:[(0,n.jsx)(z.z,{type:"default",onClick:()=>{et(void 0),J.Z.sendEvent({category:"rls_editor",action:"ai_suggestion_discarded",label:"rls-ai-assistant"},b,v)},children:"Discard"}),(0,n.jsx)(z.z,{type:"primary",onClick:()=>{ep(),J.Z.sendEvent({category:"rls_editor",action:"ai_suggestion_accepted",label:"rls-ai-assistant"},b,v)},children:"Accept"})]})]}):null,X?(0,n.jsx)(eL,{theme:"supabase",language:"pgsql",className:"grow",original:null===(s=C.current)||void 0===s?void 0:s.getValue(),modified:X,onMount:e=>E.current=e,options:{wordWrap:"on",renderSideBySide:!1,scrollBeyondLastLine:!1,renderOverviewRuler:!1,renderLineHighlight:"none",minimap:{enabled:!1},occurrencesHighlight:!1,folding:!1,selectionHighlight:!1,lineHeight:20,padding:{top:10,bottom:10}}}):null,(0,n.jsx)("div",{className:"relative h-full ".concat(X?"hidden":"block"),children:(0,n.jsx)(AIPolicyEditorPanel_RLSCodeEditor,{id:"rls-sql-policy",defaultValue:"",editorRef:C,placeholder:k})}),(0,n.jsxs)("div",{className:"flex flex-col",children:[void 0!==P&&(0,n.jsx)(AIPolicyEditorPanel_QueryError,{error:P,onSelectDebug:onSelectDebug,open:H,setOpen:q}),(0,n.jsx)(SheetFooter,{className:"flex flex-col gap-12 px-5 py-4 w-full",children:(0,n.jsxs)("div",{className:"flex justify-end gap-x-2",children:[(0,n.jsx)(z.z,{type:"default",disabled:eu,onClick:()=>o(),children:"Cancel"}),(0,n.jsx)(z.z,{loading:eu,htmlType:"submit",disabled:eu||void 0!==X,onClick:()=>eh(),children:"Save policy"})]})})]})]})]}),Q&&(0,n.jsx)("div",{className:(0,y.cn)("flex border-l grow w-full",Q&&"w-[40%]"),children:(0,n.jsx)(AIPolicyChat,{messages:ec,onSubmit:e=>eo({content:e,role:"user",createdAt:new Date}),onDiff:et,onChange:$,loading:er||em})}),(0,n.jsx)(R.Z,{visible:es,header:"Discard changes",buttonLabel:"Discard",onSelectCancel:()=>en(!1),onSelectConfirm:()=>{o(),en(!1)},children:(0,n.jsx)(I.C.Content,{children:(0,n.jsx)("p",{className:"py-4 text-sm text-foreground-light",children:"Are you sure you want to close the editor? Any unsaved changes on your policy and conversations with the Assistant will be lost."})})})]})})})});eV.displayName="AIPolicyEditorPanel";var eM=s(51373),eO=s(2755),eZ=s(7503),eF=s(97131),eH=s(50932),eq=s(20775),eW=s(97632),eU=s(12752),eY=s(93969),eG=s(99033),eQ=s(44389),eB=s(31915),eK=s(10381),e$=s(63157);let onFilterTables=(e,t,s)=>{if(!s)return e.slice().sort((e,t)=>e.name.localeCompare(t.name));{let n=s.toLowerCase(),findSearchString=e=>e.toLowerCase().includes(n),l=t.filter(e=>findSearchString(e.name));return e.slice().filter(e=>e.name.toLowerCase().includes(n)||e.id.toString()===n||l.some(t=>t.table===e.name)).sort((e,t)=>e.name.localeCompare(t.name))}},AuthPoliciesPage=()=>{let{search:e,schema:t}=(0,c.UO)(),{project:s}=(0,eO.d2)(),i=(0,eQ._2)(),[x,m]=(0,r.useState)(""),[h,p]=(0,r.useState)(!1),[f,g]=(0,r.useState)(),v=(0,d.bB)();(0,r.useEffect)(()=>{e&&m(e)},[e]),(0,r.useEffect)(()=>{t&&i.setSelectedSchemaName(t)},[t]);let{data:j}=(0,eU.Q1)({projectRef:null==s?void 0:s.ref,connectionString:null==s?void 0:s.connectionString}),[b]=o()(j,e=>{var t;return eG.F.includes(null!==(t=null==e?void 0:e.name)&&void 0!==t?t:"")}),N=null==j?void 0:j.find(e=>e.name===i.selectedSchemaName),y=b.some(e=>e.id===(null==N?void 0:N.id)),{data:w}=(0,eW.r)({projectRef:null==s?void 0:s.ref,connectionString:null==s?void 0:s.connectionString}),{data:S,isLoading:C,isSuccess:E,isError:k,error:A}=(0,eY.Bj)({projectRef:null==s?void 0:s.ref,connectionString:null==s?void 0:s.connectionString,schema:i.selectedSchemaName}),_=onFilterTables(null!=S?S:[],null!=w?w:[],x),P=(0,M.Xo)(a.KA.TENANT_SQL_ADMIN_READ,"policies"),I=(0,M.Xo)(a.KA.TENANT_SQL_ADMIN_WRITE,"policies"),R=(0,M.N4)();return R&&!P?(0,n.jsx)(eF.Z,{isFullPage:!0,resourceText:"view this project's RLS policies"}):(0,n.jsxs)("div",{className:"flex flex-col h-full",children:[(0,n.jsx)("div",{className:"mb-4",children:(0,n.jsxs)("div",{className:"flex items-center justify-between",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,n.jsx)(eH.Z,{className:"w-[260px]",size:"small",showError:!1,selectedSchemaName:i.selectedSchemaName,onSelectSchema:e=>{i.setSelectedSchemaName(e),m("")}}),(0,n.jsx)(eB.Z,{size:"small",placeholder:"Filter tables and policies",className:"block w-64 text-sm placeholder-border-muted",value:x,onChange:e=>m(e.target.value),icon:(0,n.jsx)(eK.Z,{size:"tiny"})})]}),(0,n.jsxs)("div",{className:"flex items-center gap-x-2",children:[(0,n.jsx)(z.z,{type:"default",icon:(0,n.jsx)(e$.Z,{size:14,strokeWidth:1.5}),asChild:!0,children:(0,n.jsx)("a",{target:"_blank",rel:"noreferrer",href:"https://supabase.com/docs/learn/auth-deep-dive/auth-row-level-security",children:"Documentation"})}),v&&(0,n.jsxs)(l.fC,{delayDuration:0,children:[(0,n.jsx)(l.xz,{asChild:!0,children:(0,n.jsx)(z.z,{type:"primary",disabled:!I,onClick:()=>p(!0),children:"Create a new policy"})}),R&&!I&&(0,n.jsx)(l.h_,{children:(0,n.jsxs)(l.VY,{side:"bottom",children:[(0,n.jsx)(l.Eh,{className:"radix-tooltip-arrow"}),(0,n.jsx)("div",{className:"rounded bg-alternative py-1 px-2 leading-none shadow border border-background",children:(0,n.jsx)("span",{className:"text-xs text-foreground",children:"You need additional permissions to create RLS policies"})})]})})]})]})]})}),C&&(0,n.jsx)(eq.A,{}),k&&(0,n.jsx)(eZ.Z,{error:A,subject:"Failed to retrieve tables"}),E&&(0,n.jsx)(u.rE,{tables:_,hasTables:S.length>0,isLocked:y,onSelectEditPolicy:e=>{g(e),p(!0)}}),(0,n.jsx)(eV,{visible:h,selectedPolicy:f,onSelectCancel:()=>{p(!1),g(void 0)}})]})};AuthPoliciesPage.getLayout=e=>(0,n.jsx)(eM.g1,{title:"Auth",children:(0,n.jsx)("div",{className:"h-full p-4",children:e})});var eX=AuthPoliciesPage},70971:function(e,t,s){"use strict";s.d(t,{g:function(){return AiIconChat},p:function(){return AiIcon}});var n=s(52322),l=s(9839);let AiIcon=e=>{let{className:t}=e;return(0,n.jsx)(l.c,{className:t,allowHoverEffect:!0})},AiIconChat=e=>{let{loading:t=!1}=e;return(0,n.jsx)(l.c,{className:"ml-0.5",loading:t,allowHoverEffect:!0})}},8882:function(e,t,s){"use strict";s.d(t,{t:function(){return r}});var n=s(52322);s(2784);var l=s(8897),a=s(96577),i=s.n(a),o=s(4220);let NextImageHandler=e=>(0,n.jsx)("span",{className:(0,o.cn)("next-image--dynamic-fill",e.className),children:(0,n.jsx)(i(),{...e,className:"rounded-md border",layout:"fill"})}),r={mono:e=>(0,n.jsx)("code",{className:"text-sm",children:e.children}),code:e=>(0,n.jsx)(l.d,{...e}),img:e=>NextImageHandler(e),Image:e=>NextImageHandler(e)}}},function(e){e.O(0,[1715,1187,6653,3844,8421,9362,4796,806,2591,3614,6782,9735,5525,1915,4079,4964,8211,452,8108,9774,2888,179],function(){return e(e.s=50193)}),_N_E=e.O()}]);